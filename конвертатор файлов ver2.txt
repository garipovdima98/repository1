import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from PIL import Image
import tempfile
from docx import Document
from docx.shared import Pt

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

user_data = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
        [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    await update.message.reply_text(
        "üîÑ –ë–æ—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
        [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_menu')]
    ]
    await update.message.reply_text(
        "üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:**\n\nüì∏ **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:** JPG, JPEG, PNG, WebP\nüìÑ **–î–æ–∫—É–º–µ–Ω—Ç—ã:** TXT, DOCX\n\n**–õ–∏–º–∏—Ç—ã:**\n‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –¥–æ 20 –ú–ë\n‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç—ã: –¥–æ 10 –ú–ë",
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in user_data:
        del user_data[user_id]
    await update.message.reply_text("–û—Ç–º–µ–Ω–µ–Ω–æ.")

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = update.effective_user.id

    if query.data == 'help':
        keyboard = [
            [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
            [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_menu')]
        ]
        await query.edit_message_text(
            "üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:**\n\nüì∏ **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:** JPG, JPEG, PNG, WebP\nüìÑ **–î–æ–∫—É–º–µ–Ω—Ç—ã:** TXT, DOCX\n\n**–õ–∏–º–∏—Ç—ã:**\n‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –¥–æ 20 –ú–ë\n‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç—ã: –¥–æ 10 –ú–ë",
            parse_mode='Markdown',
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    
    elif query.data == 'back_to_menu':
        await show_main_menu(query)
    
    elif query.data == 'category_images':
        await show_image_categories(query)
    
    elif query.data == 'category_documents':
        await show_document_formats(query)
    
    elif query.data == 'jpg_category':
        await show_jpg_formats(query)
    
    elif query.data == 'jpeg_category':
        await show_jpeg_formats(query)
    
    elif query.data == 'png_category':
        await show_png_formats(query)
    
    elif query.data == 'webp_category':
        await show_webp_formats(query)
    
    else:
        conversion_map = {
            'jpg_to_png': ('jpg', 'png', 20, 'üì∏'),
            'jpg_to_jpeg': ('jpg', 'jpeg', 20, 'üì∏'),
            'jpg_to_webp': ('jpg', 'webp', 20, 'üì∏'),
            'jpeg_to_png': ('jpeg', 'png', 20, 'üì∏'),
            'jpeg_to_jpg': ('jpeg', 'jpg', 20, 'üì∏'),
            'jpeg_to_webp': ('jpeg', 'webp', 20, 'üì∏'),
            'png_to_jpg': ('png', 'jpg', 20, 'üì∏'),
            'png_to_jpeg': ('png', 'jpeg', 20, 'üì∏'),
            'png_to_webp': ('png', 'webp', 20, 'üì∏'),
            'webp_to_jpg': ('webp', 'jpg', 20, 'üì∏'),
            'webp_to_jpeg': ('webp', 'jpeg', 20, 'üì∏'),
            'webp_to_png': ('webp', 'png', 20, 'üì∏'),
            'txt_to_docx': ('txt', 'docx', 10, 'üìÑ'),
            'docx_to_txt': ('docx', 'txt', 10, 'üìÑ')
        }
        
        if query.data in conversion_map:
            source, target, max_mb, emoji = conversion_map[query.data]
            user_data[user_id] = {
                'type': query.data,
                'source': source,
                'target': target,
                'max_size': max_mb * 1024 * 1024
            }
            
            await query.edit_message_text(
                f"{emoji} **{source.upper()} ‚Üí {target.upper()}**\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª .{source} (–¥–æ {max_mb} –ú–ë).\n/cancel - –æ—Ç–º–µ–Ω–∞",
                parse_mode='Markdown'
            )

async def show_main_menu(query):
    keyboard = [
        [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
        [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    await query.edit_message_text(
        "üîÑ –ë–æ—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_image_categories(query):
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è JPG —Ñ–∞–π–ª—ã", callback_data='jpg_category')],
        [InlineKeyboardButton("üñºÔ∏è JPEG —Ñ–∞–π–ª—ã", callback_data='jpeg_category')],
        [InlineKeyboardButton("üñºÔ∏è PNG —Ñ–∞–π–ª—ã", callback_data='png_category')],
        [InlineKeyboardButton("üñºÔ∏è WebP —Ñ–∞–π–ª—ã", callback_data='webp_category')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_menu')]
    ]
    await query.edit_message_text(
        "üì∏ **–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:\n‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë",
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_jpg_formats(query):
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è JPG ‚Üí PNG", callback_data='jpg_to_png')],
        [InlineKeyboardButton("üñºÔ∏è JPG ‚Üí JPEG", callback_data='jpg_to_jpeg')],
        [InlineKeyboardButton("üñºÔ∏è JPG ‚Üí WebP", callback_data='jpg_to_webp')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='category_images')]
    ]
    await query.edit_message_text(
        "üñºÔ∏è **–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: JPG**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç:",
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_jpeg_formats(query):
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è JPEG ‚Üí PNG", callback_data='jpeg_to_png')],
        [InlineKeyboardButton("üñºÔ∏è JPEG ‚Üí JPG", callback_data='jpeg_to_jpg')],
        [InlineKeyboardButton("üñºÔ∏è JPEG ‚Üí WebP", callback_data='jpeg_to_webp')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='category_images')]
    ]
    await query.edit_message_text(
        "üñºÔ∏è **–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: JPEG**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç:",
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_png_formats(query):
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è PNG ‚Üí JPG", callback_data='png_to_jpg')],
        [InlineKeyboardButton("üñºÔ∏è PNG ‚Üí JPEG", callback_data='png_to_jpeg')],
        [InlineKeyboardButton("üñºÔ∏è PNG ‚Üí WebP", callback_data='png_to_webp')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='category_images')]
    ]
    await query.edit_message_text(
        "üñºÔ∏è **–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: PNG**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç:",
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_webp_formats(query):
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è WebP ‚Üí JPG", callback_data='webp_to_jpg')],
        [InlineKeyboardButton("üñºÔ∏è WebP ‚Üí JPEG", callback_data='webp_to_jpeg')],
        [InlineKeyboardButton("üñºÔ∏è WebP ‚Üí PNG", callback_data='webp_to_png')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='category_images')]
    ]
    await query.edit_message_text(
        "üñºÔ∏è **–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: WebP**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç:",
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_document_formats(query):
    keyboard = [
        [InlineKeyboardButton("üìù TXT ‚Üí DOCX", callback_data='txt_to_docx')],
        [InlineKeyboardButton("üìù DOCX ‚Üí TXT", callback_data='docx_to_txt')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_menu')]
    ]
    await query.edit_message_text(
        "üìÑ **–ö–∞—Ç–µ–≥–æ—Ä–∏—è: –î–æ–∫—É–º–µ–Ω—Ç—ã**\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:\n‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10 –ú–ë",
        parse_mode='Markdown',
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    if user_id not in user_data:
        keyboard = [
            [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
            [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')]
        ]
        await update.message.reply_text("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.", reply_markup=InlineKeyboardMarkup(keyboard))
        return
    
    user_info = user_data[user_id]
    
    if update.message.document:
        doc = update.message.document
        file_name = doc.file_name or f"file.{user_info['source']}"
        file_ext = file_name.split('.')[-1].lower()
        
        if file_ext != user_info['source']:
            keyboard = [
                [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
                [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')]
            ]
            await update.message.reply_text(f"‚ùå –ù—É–∂–µ–Ω —Ñ–∞–π–ª .{user_info['source']}, –∞ –Ω–µ .{file_ext}", reply_markup=InlineKeyboardMarkup(keyboard))
            return
        
        if doc.file_size and doc.file_size > user_info['max_size']:
            max_mb = user_info['max_size'] // (1024 * 1024)
            await update.message.reply_text(f"‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º: {max_mb} –ú–ë.")
            return
        
        file = await doc.get_file()
        
        with tempfile.TemporaryDirectory() as tmp_dir:
            input_path = os.path.join(tmp_dir, f"input.{file_ext}")
            output_path = os.path.join(tmp_dir, f"output.{user_info['target']}")
            
            await file.download_to_drive(input_path)
            
            status_msg = await update.message.reply_text("‚è≥ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è...")
            
            try:
                if user_info['type'] in ['jpg_to_png', 'jpeg_to_png', 'webp_to_png']:
                    with Image.open(input_path) as img:
                        img.save(output_path, format='PNG')
                
                elif user_info['type'] in ['png_to_jpg', 'webp_to_jpg']:
                    with Image.open(input_path) as img:
                        if img.mode in ('RGBA', 'LA'):
                            rgb_img = Image.new('RGB', img.size, (255, 255, 255))
                            rgb_img.paste(img, mask=img.split()[-1])
                            img = rgb_img
                        img.save(output_path, format='JPEG')
                
                elif user_info['type'] in ['png_to_jpeg', 'jpg_to_jpeg', 'jpeg_to_jpg', 'webp_to_jpeg']:
                    with Image.open(input_path) as img:
                        if img.mode in ('RGBA', 'LA'):
                            rgb_img = Image.new('RGB', img.size, (255, 255, 255))
                            rgb_img.paste(img, mask=img.split()[-1])
                            img = rgb_img
                        img.save(output_path, format='JPEG')
                
                elif user_info['type'] in ['jpg_to_webp', 'jpeg_to_webp', 'png_to_webp']:
                    with Image.open(input_path) as img:
                        img.save(output_path, format='WEBP')
                
                elif user_info['type'] == 'txt_to_docx':
                    try:
                        encodings = ['utf-8', 'cp1251', 'koi8-r', 'iso-8859-5', 'cp866']
                        text = None
                        
                        for encoding in encodings:
                            try:
                                with open(input_path, 'r', encoding=encoding) as f:
                                    text = f.read()
                                break
                            except UnicodeDecodeError:
                                continue
                        
                        if text is None:
                            with open(input_path, 'r', encoding='utf-8', errors='ignore') as f:
                                text = f.read()
                        
                        docx = Document()
                        style = docx.styles['Normal']
                        style.font.name = 'Arial'
                        style.font.size = Pt(12)
                        
                        lines = text.split('\n')
                        for line in lines:
                            if line.strip():
                                docx.add_paragraph(line)
                        
                        docx.save(output_path)
                        
                    except Exception as e:
                        raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ DOCX: {str(e)}")
                
                elif user_info['type'] == 'docx_to_txt':
                    try:
                        docx = Document(input_path)
                        text = ""
                        
                        for paragraph in docx.paragraphs:
                            if paragraph.text.strip():
                                text += paragraph.text + "\n"
                        
                        with open(output_path, 'w', encoding='utf-8') as f:
                            f.write(text)
                            
                    except Exception as e:
                        raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ DOCX: {str(e)}")
                
                with open(output_path, 'rb') as f:
                    await update.message.reply_document(
                        document=f,
                        filename=f"converted.{user_info['target']}",
                        caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ!",
                        read_timeout=120,
                        write_timeout=120,
                        connect_timeout=60
                    )
                
                await status_msg.delete()
                del user_data[user_id]
                
                keyboard = [
                    [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
                    [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')]
                ]
                await update.message.reply_text("–ß—Ç–æ –¥–∞–ª—å—à–µ?", reply_markup=InlineKeyboardMarkup(keyboard))
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞: {e}")
                await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
                if 'status_msg' in locals():
                    try:
                        await status_msg.delete()
                    except:
                        pass
    else:
        await update.message.reply_text("‚ùå –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç.")

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text and not update.message.text.startswith('/'):
        await start(update, context)

def main():
    TOKEN = ""
    
    application = Application.builder().token(TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("cancel", cancel))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(filters.Document.ALL, handle_document))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    application.run_polling()

if __name__ == '__main__':
    main()

