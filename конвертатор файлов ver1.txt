import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from PIL import Image
import tempfile

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

user_data = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üì∏ JPG ‚Üí PNG", callback_data='jpg_to_png')],
        [InlineKeyboardButton("üìÑ TXT ‚Üí PDF", callback_data='txt_to_pdf')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    
    await update.message.reply_text(
        "üîÑ –ë–æ—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üì∏ JPG ‚Üí PNG", callback_data='jpg_to_png')],
        [InlineKeyboardButton("üìÑ TXT ‚Üí PDF", callback_data='txt_to_pdf')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back')]
    ]
    
    await update.message.reply_text(
        "–ß—Ç–æ —É–º–µ–µ—Ç:\n‚Ä¢ JPG ‚Üí PNG (–¥–æ 20 –ú–ë)\n‚Ä¢ TXT ‚Üí PDF (–¥–æ 10 –ú–ë)\n\n–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:\n1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø\n2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª\n3. –ü–æ–ª—É—á–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in user_data:
        del user_data[user_id]
    await update.message.reply_text("–û—Ç–º–µ–Ω–µ–Ω–æ.")

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    
    if query.data == 'help':
        keyboard = [
            [InlineKeyboardButton("üì∏ JPG ‚Üí PNG", callback_data='jpg_to_png')],
            [InlineKeyboardButton("üìÑ TXT ‚Üí PDF", callback_data='txt_to_pdf')],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back')]
        ]
        
        await query.edit_message_text(
            "–ß—Ç–æ —É–º–µ–µ—Ç:\n‚Ä¢ JPG ‚Üí PNG (–¥–æ 20 –ú–ë)\n‚Ä¢ TXT ‚Üí PDF (–¥–æ 10 –ú–ë)\n\n–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:\n1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø\n2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª\n3. –ü–æ–ª—É—á–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    
    elif query.data == 'back':
        keyboard = [
            [InlineKeyboardButton("üì∏ JPG ‚Üí PNG", callback_data='jpg_to_png')],
            [InlineKeyboardButton("üìÑ TXT ‚Üí PDF", callback_data='txt_to_pdf')],
            [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
        ]
        
        await query.edit_message_text(
            "üîÑ –ë–æ—Ç –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —Ñ–∞–π–ª–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    
    elif query.data == 'jpg_to_png':
        user_data[user_id] = {'type': 'jpg_to_png', 'source': 'jpg', 'target': 'png', 'max_size': 20 * 1024 * 1024}
        await query.edit_message_text("üì∏ JPG ‚Üí PNG\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ JPG —Ñ–∞–π–ª (–¥–æ 20 –ú–ë).\n/cancel - –æ—Ç–º–µ–Ω–∞")
    
    elif query.data == 'txt_to_pdf':
        user_data[user_id] = {'type': 'txt_to_pdf', 'source': 'txt', 'target': 'pdf', 'max_size': 10 * 1024 * 1024}
        await query.edit_message_text("üìÑ TXT ‚Üí PDF\n\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ TXT —Ñ–∞–π–ª (–¥–æ 10 –ú–ë).\n/cancel - –æ—Ç–º–µ–Ω–∞")

async def handle_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    
    if user_id not in user_data:
        keyboard = [
            [InlineKeyboardButton("üì∏ JPG ‚Üí PNG", callback_data='jpg_to_png')],
            [InlineKeyboardButton("üìÑ TXT ‚Üí PDF", callback_data='txt_to_pdf')]
        ]
        await update.message.reply_text("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.", reply_markup=InlineKeyboardMarkup(keyboard))
        return
    
    user_info = user_data[user_id]
    
    if update.message.document:
        doc = update.message.document
        file_name = doc.file_name or f"file.{user_info['source']}"
        file_ext = file_name.split('.')[-1].lower()
        
        if file_ext != user_info['source']:
            keyboard = [
                [InlineKeyboardButton("üì∏ JPG ‚Üí PNG", callback_data='jpg_to_png')],
                [InlineKeyboardButton("üìÑ TXT ‚Üí PDF", callback_data='txt_to_pdf')]
            ]
            await update.message.reply_text(f"‚ùå –ù—É–∂–µ–Ω —Ñ–∞–π–ª .{user_info['source']}, –∞ –Ω–µ .{file_ext}", reply_markup=InlineKeyboardMarkup(keyboard))
            return
        
        if doc.file_size and doc.file_size > user_info['max_size']:
            max_mb = user_info['max_size'] // (1024 * 1024)
            await update.message.reply_text(f"‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º: {max_mb} –ú–ë.")
            return
        
        file = await doc.get_file()
        
        with tempfile.TemporaryDirectory() as tmp_dir:
            input_path = os.path.join(tmp_dir, f"input.{user_info['source']}")
            output_path = os.path.join(tmp_dir, f"output.{user_info['target']}")
            
            await file.download_to_drive(input_path)
            
            status_msg = await update.message.reply_text("‚è≥ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è...")
            
            try:
                if user_info['type'] == 'jpg_to_png':
                    with Image.open(input_path) as img:
                        img.save(output_path, format='PNG')
                elif user_info['type'] == 'txt_to_pdf':
                    from fpdf import FPDF
                    pdf = FPDF()
                    pdf.add_page()
                    pdf.set_font("Arial", size=12)
                    
                    encodings = ['utf-8', 'cp1251', 'iso-8859-1', 'cp866']
                    text = None
                    
                    for encoding in encodings:
                        try:
                            with open(input_path, 'r', encoding=encoding) as f:
                                text = f.read()
                            break
                        except UnicodeDecodeError:
                            continue
                    
                    if text is None:
                        raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª")
                    
                    for line in text.split('\n'):
                        if len(line) > 100:
                            chunks = [line[i:i+100] for i in range(0, len(line), 100)]
                            for chunk in chunks:
                                pdf.cell(200, 10, txt=chunk, ln=True)
                        else:
                            pdf.cell(200, 10, txt=line, ln=True)
                    
                    pdf.output(output_path)
                
                with open(output_path, 'rb') as f:
                    await update.message.reply_document(
                        document=f,
                        filename=f"converted.{user_info['target']}",
                        caption=f"‚úÖ –ì–æ—Ç–æ–≤–æ!",
                        read_timeout=120,
                        write_timeout=120,
                        connect_timeout=60
                    )
                
                await status_msg.delete()
                del user_data[user_id]
                
                keyboard = [
                    [InlineKeyboardButton("üì∏ JPG ‚Üí PNG", callback_data='jpg_to_png')],
                    [InlineKeyboardButton("üìÑ TXT ‚Üí PDF", callback_data='txt_to_pdf')]
                ]
                await update.message.reply_text("–ß—Ç–æ –¥–∞–ª—å—à–µ?", reply_markup=InlineKeyboardMarkup(keyboard))
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞: {e}")
                await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
                if 'status_msg' in locals():
                    try:
                        await status_msg.delete()
                    except:
                        pass
    else:
        await update.message.reply_text("‚ùå –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç.")

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text and not update.message.text.startswith('/'):
        await start(update, context)

def main():
    TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê"
    
    application = Application.builder().token(TOKEN).build()
    
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("cancel", cancel))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(filters.Document.ALL, handle_document))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    application.run_polling()

if __name__ == '__main__':
    main()