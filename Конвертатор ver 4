import os
import sys
import json
import time
import logging
import asyncio
import aiohttp
import sqlite3
from datetime import datetime, timedelta
from typing import Optional, Dict, List, Any, Tuple
from collections import defaultdict
from functools import wraps
from pathlib import Path

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from telegram.constants import ParseMode
from PIL import Image
import io
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.utils import simpleSplit
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
import mimetypes
import hashlib
import re

# ==================== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ====================

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO,
    handlers=[
        logging.FileHandler('bot.log', encoding='utf-8'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

# ==================== –ö–û–ù–°–¢–ê–ù–¢–´ ====================

TOKEN =
ADMIN_IDS = [5277965812]  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à Telegram ID
DB_PATH = "bot_database.db"

# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ GIF (4 –º–∏–Ω—É—Ç—ã = 240 —Å–µ–∫—É–Ω–¥)
MAX_GIF_DURATION = 240

# ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–• ====================

class Database:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö SQLite"""
    
    def __init__(self, db_path: str):
        self.db_path = db_path
        self._init_db()
    
    def _init_db(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            
            # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    user_id INTEGER PRIMARY KEY,
                    username TEXT,
                    first_name TEXT,
                    last_name TEXT,
                    joined_date TIMESTAMP,
                    last_activity TIMESTAMP,
                    total_conversions INTEGER DEFAULT 0,
                    total_files INTEGER DEFAULT 0,
                    is_banned INTEGER DEFAULT 0,
                    ban_reason TEXT,
                    banned_date TIMESTAMP,
                    banned_by INTEGER
                )
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS conversions (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER,
                    conversion_type TEXT,
                    source_format TEXT,
                    target_format TEXT,
                    file_size INTEGER,
                    success INTEGER DEFAULT 0,
                    error_message TEXT,
                    timestamp TIMESTAMP,
                    duration_ms INTEGER,
                    FOREIGN KEY (user_id) REFERENCES users(user_id)
                )
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤ –¥–µ–π—Å—Ç–≤–∏–π
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS logs (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER,
                    action TEXT,
                    details TEXT,
                    timestamp TIMESTAMP,
                    FOREIGN KEY (user_id) REFERENCES users(user_id)
                )
            ''')
            
            # –¢–∞–±–ª–∏—Ü–∞ –±–∞–Ω–æ–≤ (–∏—Å—Ç–æ—Ä–∏—è)
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS bans (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER,
                    admin_id INTEGER,
                    reason TEXT,
                    banned_date TIMESTAMP,
                    unbanned_date TIMESTAMP,
                    is_active INTEGER DEFAULT 1,
                    FOREIGN KEY (user_id) REFERENCES users(user_id),
                    FOREIGN KEY (admin_id) REFERENCES users(user_id)
                )
            ''')
            
            conn.commit()
    
    # ========== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ==========
    
    def add_user(self, user_id: int, username: str = None, first_name: str = None, last_name: str = None):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO users (user_id, username, first_name, last_name, joined_date, last_activity)
                VALUES (?, ?, ?, ?, ?, ?)
                ON CONFLICT(user_id) DO UPDATE SET
                    username = excluded.username,
                    first_name = excluded.first_name,
                    last_name = excluded.last_name,
                    last_activity = excluded.last_activity
            ''', (user_id, username, first_name, last_name, datetime.now(), datetime.now()))
            conn.commit()
    
    def update_activity(self, user_id: int):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                UPDATE users SET last_activity = ? WHERE user_id = ?
            ''', (datetime.now(), user_id))
            conn.commit()
    
    def get_user(self, user_id: int) -> Optional[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT user_id, username, first_name, last_name, joined_date, last_activity,
                       total_conversions, total_files, is_banned, ban_reason
                FROM users WHERE user_id = ?
            ''', (user_id,))
            row = cursor.fetchone()
            if row:
                return {
                    'user_id': row[0],
                    'username': row[1],
                    'first_name': row[2],
                    'last_name': row[3],
                    'joined_date': row[4],
                    'last_activity': row[5],
                    'total_conversions': row[6],
                    'total_files': row[7],
                    'is_banned': row[8],
                    'ban_reason': row[9]
                }
            return None
    
    # ========== –ë–ê–ù–´ ==========
    
    def is_banned(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('SELECT is_banned FROM users WHERE user_id = ?', (user_id,))
            result = cursor.fetchone()
            return result is not None and result[0] == 1
    
    def ban_user(self, user_id: int, admin_id: int, reason: str = None):
        """–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                UPDATE users SET 
                    is_banned = 1, 
                    ban_reason = ?, 
                    banned_date = ?,
                    banned_by = ?
                WHERE user_id = ?
            ''', (reason, datetime.now(), admin_id, user_id))
            
            cursor.execute('''
                INSERT INTO bans (user_id, admin_id, reason, banned_date, is_active)
                VALUES (?, ?, ?, ?, 1)
            ''', (user_id, admin_id, reason, datetime.now()))
            
            conn.commit()
    
    def unban_user(self, user_id: int):
        """–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                UPDATE users SET is_banned = 0, ban_reason = NULL, banned_date = NULL, banned_by = NULL
                WHERE user_id = ?
            ''', (user_id,))
            
            cursor.execute('''
                UPDATE bans SET is_active = 0, unbanned_date = ? 
                WHERE user_id = ? AND is_active = 1
            ''', (datetime.now(), user_id))
            
            conn.commit()
    
    def get_banned_users(self) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT user_id, username, first_name, last_name, ban_reason, banned_date
                FROM users WHERE is_banned = 1
                ORDER BY banned_date DESC
            ''')
            users = []
            for row in cursor.fetchall():
                users.append({
                    'user_id': row[0],
                    'username': row[1],
                    'first_name': row[2],
                    'last_name': row[3],
                    'ban_reason': row[4],
                    'banned_date': row[5]
                })
            return users
    
    # ========== –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò ==========
    
    def log_conversion(self, user_id: int, conv_type: str, source: str, target: str,
                      file_size: int, success: bool, error: str = None, duration: int = 0):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO conversions 
                (user_id, conversion_type, source_format, target_format, file_size, success, 
                 error_message, timestamp, duration_ms)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (user_id, conv_type, source, target, file_size, 1 if success else 0, 
                  error, datetime.now(), duration))
            
            if success:
                cursor.execute('''
                    UPDATE users SET 
                        total_conversions = total_conversions + 1, 
                        total_files = total_files + 1
                    WHERE user_id = ?
                ''', (user_id,))
            
            conn.commit()
    
    def get_user_stats(self, user_id: int) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT total_conversions, total_files, joined_date, last_activity
                FROM users WHERE user_id = ?
            ''', (user_id,))
            row = cursor.fetchone()
            
            if row:
                return {
                    'total_conversions': row[0],
                    'total_files': row[1],
                    'joined_date': row[2],
                    'last_activity': row[3]
                }
            return {}
    
    def get_total_stats(self) -> Dict:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            
            cursor.execute('''
                SELECT 
                    COUNT(DISTINCT user_id) as total_users,
                    SUM(total_conversions) as total_conversions,
                    SUM(total_files) as total_files,
                    AVG(total_conversions) as avg_conversions
                FROM users WHERE is_banned = 0
            ''')
            stats = cursor.fetchone()
            
            cursor.execute('SELECT COUNT(*) FROM users WHERE is_banned = 1')
            banned_count = cursor.fetchone()[0]
            
            today = datetime.now().date()
            cursor.execute('''
                SELECT COUNT(*) FROM conversions 
                WHERE date(timestamp) = date(?)
            ''', (today,))
            today_conversions = cursor.fetchone()[0]
            
            cursor.execute('''
                SELECT 
                    SUM(CASE WHEN success = 1 THEN 1 ELSE 0 END) as success,
                    SUM(CASE WHEN success = 0 THEN 1 ELSE 0 END) as failed
                FROM conversions
            ''')
            success_stats = cursor.fetchone()
            
            return {
                'total_users': stats[0] or 0,
                'total_conversions': stats[1] or 0,
                'total_files': stats[2] or 0,
                'avg_conversions': round(stats[3] or 0, 1),
                'banned_users': banned_count,
                'today_conversions': today_conversions or 0,
                'successful_conversions': success_stats[0] or 0,
                'failed_conversions': success_stats[1] or 0
            }
    
    def get_recent_conversions(self, limit: int = 10) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT c.user_id, u.username, u.first_name, c.conversion_type, 
                       c.source_format, c.target_format, c.success, c.timestamp
                FROM conversions c
                JOIN users u ON c.user_id = u.user_id
                ORDER BY c.timestamp DESC LIMIT ?
            ''', (limit,))
            
            conversions = []
            for row in cursor.fetchall():
                conversions.append({
                    'user_id': row[0],
                    'username': row[1] or f"ID: {row[0]}",
                    'first_name': row[2],
                    'conversion_type': row[3],
                    'source': row[4],
                    'target': row[5],
                    'success': row[6],
                    'timestamp': row[7]
                })
            return conversions
    
    def get_top_users(self, limit: int = 5) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT user_id, username, first_name, total_conversions, total_files
                FROM users
                WHERE is_banned = 0 AND total_conversions > 0
                ORDER BY total_conversions DESC
                LIMIT ?
            ''', (limit,))
            
            users = []
            for row in cursor.fetchall():
                users.append({
                    'user_id': row[0],
                    'username': row[1] or f"ID: {row[0]}",
                    'first_name': row[2],
                    'total_conversions': row[3],
                    'total_files': row[4]
                })
            return users
    
    # ========== –õ–û–ì–ò ==========
    
    def log_action(self, user_id: int, action: str, details: str = None):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO logs (user_id, action, details, timestamp)
                VALUES (?, ?, ?, ?)
            ''', (user_id, action, details, datetime.now()))
            conn.commit()
    
    def get_all_logs(self, limit: int = 50) -> List[Dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–æ–≥–æ–≤"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT l.user_id, u.username, l.action, l.details, l.timestamp
                FROM logs l
                JOIN users u ON l.user_id = u.user_id
                ORDER BY l.timestamp DESC
                LIMIT ?
            ''', (limit,))
            
            logs = []
            for row in cursor.fetchall():
                logs.append({
                    'user_id': row[0],
                    'username': row[1] or f"ID: {row[0]}",
                    'action': row[2],
                    'details': row[3],
                    'timestamp': row[4]
                })
            return logs

# ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–î ====================

db = Database(DB_PATH)

# ==================== –î–ï–ö–û–†–ê–¢–û–† –î–õ–Ø –ü–†–û–í–ï–†–ö–ò –ë–ê–ù–ê ====================

def check_ban(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"""
    @wraps(func)
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE, *args, **kwargs):
        user_id = update.effective_user.id
        
        if db.is_banned(user_id):
            user = db.get_user(user_id)
            ban_reason = user.get('ban_reason', '–ù–µ —É–∫–∞–∑–∞–Ω–∞') if user else '–ù–µ —É–∫–∞–∑–∞–Ω–∞'
            await update.message.reply_text(
                "‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n\n"
                f"–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.\n"
                f"–ü—Ä–∏—á–∏–Ω–∞: {ban_reason}\n\n"
                f"–ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ —ç—Ç–æ –æ—à–∏–±–∫–æ–π, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
            )
            return
        
        return await func(update, context, *args, **kwargs)
    return wrapper

def check_ban_callback(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–Ω–∞ –≤ callback-–∑–∞–ø—Ä–æ—Å–∞—Ö"""
    @wraps(func)
    async def wrapper(update: Update, context: ContextTypes.DEFAULT_TYPE, *args, **kwargs):
        user_id = update.effective_user.id
        
        if db.is_banned(user_id):
            await update.callback_query.answer("‚õî –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã!", show_alert=True)
            return
        
        return await func(update, context, *args, **kwargs)
    return wrapper

# ==================== –û–ù–õ–ê–ô–ù –ö–û–ù–í–ï–†–¢–ï–† ====================

# ==================== –û–ù–õ–ê–ô–ù –ö–û–ù–í–ï–†–¢–ï–† ====================

class OnlineConverter:
    """–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –¥–ª—è –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ —á–µ—Ä–µ–∑ –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã"""
    
    def __init__(self):
        self.session: Optional[aiohttp.ClientSession] = None
        self.conversion_history = []
        self.failed_attempts = defaultdict(int)
        
    async def __aenter__(self):
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö –≤–∏–¥–µ–æ (–¥–æ 5 –º–∏–Ω—É—Ç)
        self.session = aiohttp.ClientSession(
            timeout=aiohttp.ClientTimeout(total=300, sock_read=120, sock_connect=30),
            headers={
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
            }
        )
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if self.session:
            await self.session.close()
    
    async def convert_file(self, file_bytes: bytes, from_format: str, to_format: str, 
                          filename: str = "file") -> bytes:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã"""
        
        methods = [
            self._convert_via_cloudconvert,
            self._convert_via_ezgif,
            self._convert_via_onlineconvertfree,
        ]
        
        max_size_mb = 50
        if len(file_bytes) > max_size_mb * 1024 * 1024:
            raise Exception(f"–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º: {max_size_mb} –ú–ë")
        
        last_error = None
        for method in methods:
            try:
                logger.info(f"–ü—Ä–æ–±—É–µ–º –º–µ—Ç–æ–¥ {method.__name__} –¥–ª—è {from_format}->{to_format}")
                result = await method(file_bytes, from_format, to_format, filename)
                
                if result and len(result) > 100:
                    self.conversion_history.append({
                        'timestamp': time.time(),
                        'from': from_format,
                        'to': to_format,
                        'size': len(file_bytes),
                        'method': method.__name__
                    })
                    self.failed_attempts[method.__name__] = 0
                    return result
                    
            except asyncio.TimeoutError:
                logger.warning(f"–¢–∞–π–º–∞—É—Ç –º–µ—Ç–æ–¥–∞ {method.__name__}")
                last_error = "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (–≤–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ)"
                self.failed_attempts[method.__name__] += 1
                continue
            except Exception as e:
                logger.warning(f"–ú–µ—Ç–æ–¥ {method.__name__} –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª: {e}")
                last_error = str(e)
                self.failed_attempts[method.__name__] += 1
                continue
        
        raise Exception(f"‚ùå –û–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {last_error}")
    
    async def _convert_via_cloudconvert(self, file_bytes: bytes, from_format: str, 
                                       to_format: str, filename: str) -> bytes:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ CloudConvert (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –∫–ª—é—á–∞)"""
        
        # 1. –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É
        job_url = "https://api.cloudconvert.com/v2/jobs"
        
        job_data = {
            "tasks": {
                "upload-my-file": {
                    "operation": "import/upload"
                },
                "convert-my-file": {
                    "operation": "convert",
                    "input": ["upload-my-file"],
                    "output_format": to_format,
                    "input_format": from_format,
                    "engine": "ffmpeg" if from_format in ['mp4', 'mov', 'avi', 'gif'] else "office",
                    "filename": f"{filename}.{to_format}"
                },
                "export-my-file": {
                    "operation": "export/url",
                    "input": ["convert-my-file"]
                }
            }
        }
        
        async with self.session.post(job_url, json=job_data) as resp:
            if resp.status not in [200, 201]:
                raise Exception(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏: {resp.status}")
            
            job = await resp.json()
            job_id = job['data']['id']
        
        # 2. –ü–æ–ª—É—á–∞–µ–º URL –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
        task_url = f"https://api.cloudconvert.com/v2/tasks"
        async with self.session.get(task_url) as resp:
            if resp.status != 200:
                raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∑–∞–¥–∞—á—É")
            
            tasks = await resp.json()
            upload_task = None
            for task in tasks['data']:
                if task['job_id'] == job_id and task['operation'] == 'import/upload':
                    upload_task = task
                    break
            
            if not upload_task:
                raise Exception("–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞–¥–∞—á–∞ –∑–∞–≥—Ä—É–∑–∫–∏")
            
            upload_url = upload_task['result']['form']['url']
            upload_params = upload_task['result']['form']['parameters']
        
        # 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
        form_data = aiohttp.FormData()
        for key, value in upload_params.items():
            form_data.add_field(key, value)
        form_data.add_field('file', file_bytes, filename=f'{filename}.{from_format}')
        
        async with self.session.post(upload_url, data=form_data) as resp:
            if resp.status not in [200, 201, 204]:
                raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: {resp.status}")
        
        # 4. –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        for _ in range(60):  # –ú–∞–∫—Å–∏–º—É–º 60 –ø–æ–ø—ã—Ç–æ–∫ (5 –º–∏–Ω—É—Ç)
            await asyncio.sleep(5)
            
            async with self.session.get(f"https://api.cloudconvert.com/v2/jobs/{job_id}") as resp:
                if resp.status != 200:
                    continue
                
                job_status = await resp.json()
                status = job_status['data']['status']
                
                if status == 'finished':
                    # –ü–æ–ª—É—á–∞–µ–º URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                    for task in job_status['data']['tasks']:
                        if task['operation'] == 'export/url' and task['status'] == 'finished':
                            files = task['result'].get('files', [])
                            if files:
                                download_url = files[0].get('url')
                                if download_url:
                                    async with self.session.get(download_url) as download_resp:
                                        if download_resp.status == 200:
                                            return await download_resp.read()
                    break
                elif status == 'error':
                    raise Exception("–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –Ω–∞ CloudConvert")
        
        raise Exception("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏")
    
    async def _convert_via_ezgif(self, file_bytes: bytes, from_format: str, 
                                to_format: str, filename: str) -> bytes:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ EZGif (–¥–ª—è GIF ‚Üî MP4)"""
        
        if from_format not in ['gif', 'mp4'] or to_format not in ['gif', 'mp4']:
            raise Exception("EZGif –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ GIF –∏ MP4")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º endpoint
        if from_format == 'gif' and to_format == 'mp4':
            endpoint = "https://ezgif.com/gif-to-mp4"
        elif from_format == 'mp4' and to_format == 'gif':
            endpoint = "https://ezgif.com/video-to-gif"
        else:
            raise Exception(f"EZGif –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç {from_format}‚Üí{to_format}")
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
        form_data = aiohttp.FormData()
        form_data.add_field('new-image', 
                          file_bytes,
                          filename=f'{filename}.{from_format}',
                          content_type=self._get_mime_type(from_format))
        
        async with self.session.post(endpoint, data=form_data) as resp:
            if resp.status != 200:
                raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {resp.status}")
            
            html = await resp.text()
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º hash –∏–∑ –æ—Ç–≤–µ—Ç–∞
            import re
            match = re.search(r'name="file" value="([^"]+)"', html)
            if not match:
                raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å hash —Ñ–∞–π–ª–∞")
            
            file_hash = match.group(1)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
            convert_data = {
                'file': file_hash,
                'start': '0',
                'end': '240',  # –î–æ 4 –º–∏–Ω—É—Ç
                'size': 'original',
                'fps': '10',
                'method': 'ffmpeg',
                'convert': 'Convert!'
            }
            
            async with self.session.post(endpoint, data=convert_data) as resp:
                if resp.status != 200:
                    raise Exception(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: {resp.status}")
                
                html = await resp.text()
                
                # –ò–∑–≤–ª–µ–∫–∞–µ–º URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                match = re.search(r'href="([^"]+\.mp4)"', html)
                if not match and to_format == 'gif':
                    match = re.search(r'href="([^"]+\.gif)"', html)
                
                if match:
                    download_path = match.group(1)
                    if not download_path.startswith('http'):
                        download_url = f"https:{download_path}"
                    else:
                        download_url = download_path
                    
                    async with self.session.get(download_url) as download_resp:
                        if download_resp.status == 200:
                            return await download_resp.read()
        
        raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Å EZGif")
    
    async def _convert_via_onlineconvertfree(self, file_bytes: bytes, from_format: str, 
                                            to_format: str, filename: str) -> bytes:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ OnlineConvertFree"""
        
        # 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
        upload_url = "https://onlineconvertfree.com/api/upload/"
        
        form_data = aiohttp.FormData()
        form_data.add_field('file', 
                          file_bytes,
                          filename=f'{filename}.{from_format}',
                          content_type=self._get_mime_type(from_format))
        
        async with self.session.post(upload_url, data=form_data) as resp:
            if resp.status != 200:
                raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {resp.status}")
            
            upload_result = await resp.json()
            file_id = upload_result.get('file_id')
            
            if not file_id:
                raise Exception("–ù–µ –ø–æ–ª—É—á–µ–Ω ID —Ñ–∞–π–ª–∞")
        
        # 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
        convert_url = f"https://onlineconvertfree.com/api/convert/{file_id}/{to_format}/"
        
        async with self.session.get(convert_url) as resp:
            if resp.status != 200:
                raise Exception(f"–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: {resp.status}")
            
            convert_result = await resp.json()
            task_id = convert_result.get('task_id')
            
            if not task_id:
                raise Exception("–ù–µ –ø–æ–ª—É—á–µ–Ω ID –∑–∞–¥–∞—á–∏")
        
        # 3. –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        for _ in range(60):  # –ú–∞–∫—Å–∏–º—É–º 60 –ø–æ–ø—ã—Ç–æ–∫
            await asyncio.sleep(3)
            
            status_url = f"https://onlineconvertfree.com/api/status/{task_id}/"
            async with self.session.get(status_url) as resp:
                if resp.status != 200:
                    continue
                
                status_data = await resp.json()
                status = status_data.get('status')
                
                if status == 'finished':
                    download_url = status_data.get('download_url')
                    if download_url:
                        async with self.session.get(download_url) as download_resp:
                            if download_resp.status == 200:
                                return await download_resp.read()
                    break
                elif status == 'error':
                    raise Exception("–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏")
        
        raise Exception("–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏")
    
    def _get_mime_type(self, file_format: str) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ MIME-—Ç–∏–ø–∞ –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é"""
        mime_map = {
            'mp4': 'video/mp4',
            'gif': 'image/gif',
            'mp3': 'audio/mpeg',
            'wav': 'audio/wav',
            'flac': 'audio/flac',
            'avi': 'video/x-msvideo',
            'mov': 'video/quicktime',
            'webm': 'video/webm',
            'jpg': 'image/jpeg',
            'jpeg': 'image/jpeg',
            'png': 'image/png',
            'webp': 'image/webp',
        }
        return mime_map.get(file_format.lower(), 'application/octet-stream')

online_converter = OnlineConverter()

# ==================== –§–£–ù–ö–¶–ò–ò –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –¢–ò–ü–û–í ====================

def detect_file_type(file_bytes: bytes, filename: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é"""
    filename_lower = filename.lower()
    
    if filename_lower.endswith('.gif'):
        return 'GIF'
    elif filename_lower.endswith(('.mp4', '.mov', '.avi', '.mkv', '.webm')):
        return 'video'
    elif filename_lower.endswith(('.jpg', '.jpeg')):
        return 'jpg'
    elif filename_lower.endswith('.png'):
        return 'png'
    elif filename_lower.endswith('.webp'):
        return 'webp'
    elif filename_lower.endswith('.txt'):
        return 'txt'
    elif filename_lower.endswith('.pdf'):
        return 'pdf'
    
    if len(file_bytes) >= 8:
        if file_bytes[:6] in [b'GIF87a', b'GIF89a']:
            return 'GIF'
        elif file_bytes[:8] == b'\x89PNG\r\n\x1a\n':
            return 'png'
        elif file_bytes[:2] == b'\xff\xd8':
            return 'jpg'
        elif len(file_bytes) >= 12 and file_bytes[:4] == b'RIFF' and file_bytes[8:12] == b'WEBP':
            return 'webp'
        elif file_bytes[:4] == b'%PDF':
            return 'pdf'
    
    return 'unknown'

# ==================== –§–£–ù–ö–¶–ò–ò –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò ====================

async def convert_txt_to_pdf(txt_content: str) -> bytes:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è TXT –≤ PDF"""
    try:
        buffer = io.BytesIO()
        c = canvas.Canvas(buffer, pagesize=A4)
        width, height = A4
        
        c.setFont("Helvetica", 11)
        margin = 50
        y = height - margin
        line_height = 14
        
        lines = txt_content.split('\n')
        
        for line in lines:
            if y < margin:
                c.showPage()
                c.setFont("Helvetica", 11)
                y = height - margin
            
            if len(line) > 80:
                words = line.split()
                current_line = ""
                for word in words:
                    test_line = current_line + " " + word if current_line else word
                    if c.stringWidth(test_line, "Helvetica", 11) < width - 2 * margin:
                        current_line = test_line
                    else:
                        c.drawString(margin, y, current_line)
                        y -= line_height
                        current_line = word
                        if y < margin:
                            c.showPage()
                            c.setFont("Helvetica", 11)
                            y = height - margin
                if current_line:
                    c.drawString(margin, y, current_line)
                    y -= line_height
            else:
                c.drawString(margin, y, line)
                y -= line_height
        
        c.save()
        buffer.seek(0)
        return buffer.getvalue()
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ TXT –≤ PDF: {e}")
        raise Exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å TXT –≤ PDF: {str(e)[:100]}")

async def convert_pdf_to_txt(pdf_bytes: bytes) -> str:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è PDF –≤ TXT (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)"""
    try:
        return "üìÑ PDF —Ñ–∞–π–ª –ø–æ–ª—É—á–µ–Ω.\n\n–î–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã:\n‚Ä¢ Adobe Acrobat Reader\n‚Ä¢ –û–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã\n‚Ä¢ –ü—Ä–æ–≥—Ä–∞–º–º—ã –¥–ª—è OCR"
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ PDF –≤ TXT: {e}")
        raise Exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å PDF: {str(e)[:100]}")

async def convert_image(file_bytes: bytes, source_format: str, target_format: str) -> bytes:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
    try:
        loop = asyncio.get_event_loop()
        
        def _convert():
            with Image.open(io.BytesIO(file_bytes)) as img:
                if target_format in ['jpg', 'jpeg'] and img.mode in ['RGBA', 'LA', 'P']:
                    background = Image.new('RGB', img.size, (255, 255, 255))
                    if img.mode == 'RGBA':
                        background.paste(img, mask=img.split()[3])
                    else:
                        background.paste(img)
                    img = background
                elif target_format == 'png' and img.mode in ['1', 'P']:
                    img = img.convert('RGBA')
                
                output = io.BytesIO()
                save_params = {'format': target_format.upper() if target_format != 'jpg' else 'JPEG'}
                
                if target_format in ['jpg', 'jpeg']:
                    save_params['quality'] = 92
                    save_params['optimize'] = True
                elif target_format == 'png':
                    save_params['optimize'] = True
                    save_params['compress_level'] = 6
                elif target_format == 'webp':
                    save_params['quality'] = 85
                    save_params['method'] = 6
                elif target_format == 'GIF':
                    save_params['save_all'] = True
                    if hasattr(img, 'is_animated') and img.is_animated:
                        save_params['duration'] = img.info.get('duration', 100)
                
                img.save(output, **save_params)
                output.seek(0)
                return output.getvalue()
        
        return await loop.run_in_executor(None, _convert)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è {source_format}->{target_format}: {e}")
        raise Exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {str(e)[:100]}")

async def convert_video_via_api(file_bytes: bytes, conv_type: str, original_name: str) -> Dict:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ –æ–Ω–ª–∞–π–Ω API —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º"""
    
    format_map = {
        'GIF_to_mp4': ('gif', 'mp4'),
        'mp4_to_GIF': ('mp4', 'gif'),
        'video_to_mp3': ('mp4', 'mp3'),
        'video_to_wav': ('mp4', 'wav'),
        'video_to_flac': ('mp4', 'flac')
    }
    
    if conv_type not in format_map:
        raise Exception(f"–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: {conv_type}")
    
    from_ext, to_ext = format_map[conv_type]
    
    try:
        logger.info(f"–ù–∞—á–∏–Ω–∞—é –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é: {from_ext} -> {to_ext}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
        max_retries = 3
        for attempt in range(max_retries):
            try:
                async with online_converter as converter:
                    converted_bytes = await converter.convert_file(
                        file_bytes, 
                        from_ext, 
                        to_ext,
                        original_name.split('.')[0]
                    )
                    
                    if converted_bytes and len(converted_bytes) > 100:
                        break
                    
            except Exception as e:
                logger.warning(f"–ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries} –Ω–µ —É–¥–∞–ª–∞—Å—å: {e}")
                if attempt == max_retries - 1:
                    raise
                await asyncio.sleep(2 * (attempt + 1))  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
        
        if '.' in original_name:
            name_without_ext = original_name.rsplit('.', 1)[0]
        else:
            name_without_ext = original_name
        
        new_filename = f"{name_without_ext}_converted.{to_ext}"
        
        mime_types = {
            'mp4': 'video/mp4',
            'gif': 'image/gif',
            'mp3': 'audio/mpeg',
            'wav': 'audio/wav',
            'flac': 'audio/flac'
        }
        
        return {
            'bytes': converted_bytes,
            'filename': new_filename,
            'mime_type': mime_types.get(to_ext, 'application/octet-stream')
        }
        
    except asyncio.TimeoutError:
        logger.error(f"–¢–∞–π–º–∞—É—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∏–¥–µ–æ {conv_type}")
        raise Exception("‚ùå –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–∏–¥–µ–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–∏–¥–µ–æ –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –∏–ª–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: {e}")
        raise Exception(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∏–¥–µ–æ: {str(e)[:150]}")

# ==================== –û–°–ù–û–í–ù–´–ï –î–ê–ù–ù–´–ï ====================

user_data = {}
processing_files = {}
privacy_accepted = {}

user_data_lock = asyncio.Lock()
processing_files_lock = asyncio.Lock()

# ==================== –ê–î–ú–ò–ù –ö–û–ú–ê–ù–î–´ ====================

async def admin_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å"""
    user_id = update.effective_user.id
    
    if user_id not in ADMIN_IDS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
        return
    
    keyboard = [
        [InlineKeyboardButton("üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='admin_stats')],
        [InlineKeyboardButton("üë• –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data='admin_top')],
        [InlineKeyboardButton("üî® –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data='admin_ban_menu')],
        [InlineKeyboardButton("‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data='admin_unban_menu')],
        [InlineKeyboardButton("‚õî –°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö", callback_data='admin_banned_list')],
        [InlineKeyboardButton("üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏", callback_data='admin_logs')],
        [InlineKeyboardButton("üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data='admin_search')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data='back_to_menu')]
    ]
    
    await update.message.reply_text(
        "üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def admin_stats_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    if user_id not in ADMIN_IDS:
        await query.edit_message_text("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞")
        return
    
    stats = db.get_total_stats()
    recent = db.get_recent_conversions(5)
    
    total_conv = stats['successful_conversions'] + stats['failed_conversions']
    success_rate = (stats['successful_conversions'] / total_conv * 100) if total_conv > 0 else 0
    
    message = f"""üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞

üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
‚Ä¢ –í—Å–µ–≥–æ: {stats['total_users']}
‚Ä¢ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: {stats['banned_users']}
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö: {stats['total_users'] - stats['banned_users']}

üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:
‚Ä¢ –í—Å–µ–≥–æ: {stats['total_conversions']}
‚Ä¢ –ó–∞ —Å–µ–≥–æ–¥–Ω—è: {stats['today_conversions']}
‚Ä¢ –£—Å–ø–µ—à–Ω–æ: {stats['successful_conversions']}
‚Ä¢ –û—à–∏–±–æ–∫: {stats['failed_conversions']}
‚Ä¢ –£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {success_rate:.1f}%

üìÅ –§–∞–π–ª—ã:
‚Ä¢ –í—Å–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {stats['total_files']}
‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {stats['avg_conversions']}

üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:
"""
    
    for conv in recent:
        status = "‚úÖ" if conv['success'] else "‚ùå"
        username = conv['username'] or f"ID: {conv['user_id']}"
        conv_type = f"{conv['source']}‚Üí{conv['target']}" if conv['source'] and conv['target'] else conv['conversion_type']
        timestamp = conv['timestamp'][:16] if isinstance(conv['timestamp'], str) else str(conv['timestamp'])[:16]
        message += f"{status} {username} - {conv_type} [{timestamp}]\n"
    
    keyboard = [
        [InlineKeyboardButton("üë• –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data='admin_top')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')]
    ]
    
    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def admin_top_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    if user_id not in ADMIN_IDS:
        return
    
    top_users = db.get_top_users(10)
    
    message = "üë• –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è–º\n\n"
    
    if top_users:
        for i, user in enumerate(top_users, 1):
            medal = "ü•á" if i == 1 else "ü•à" if i == 2 else "ü•â" if i == 3 else f"{i}."
            name = user['first_name'] or user['username'] or f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user['user_id']}"
            message += f"{medal} {name}\n"
            message += f"   ‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π: {user['total_conversions']}\n"
            message += f"   ‚Ä¢ –§–∞–π–ª–æ–≤: {user['total_files']}\n"
            message += f"   ‚Ä¢ ID: {user['user_id']}\n\n"
    else:
        message += "–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è–º–∏."
    
    keyboard = [
        [InlineKeyboardButton("üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='admin_stats')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')]
    ]
    
    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def admin_ban_menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ú–µ–Ω—é –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    if user_id not in ADMIN_IDS:
        return
    
    await query.edit_message_text(
        "üî® –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–∏—á–∏–Ω—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "/ban 123456789 –ü—Ä–∏—á–∏–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏\n\n"
        "–ü—Ä–∏–º–µ—Ä: /ban 987654321 –°–ø–∞–º",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')]
        ])
    )

async def ban_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /ban –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"""
    admin_id = update.effective_user.id
    
    if admin_id not in ADMIN_IDS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
        return
    
    args = context.args
    if len(args) < 1:
        await update.message.reply_text(
            "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ban <user_id> [–ø—Ä–∏—á–∏–Ω–∞]"
        )
        return
    
    try:
        target_id = int(args[0])
        reason = ' '.join(args[1:]) if len(args) > 1 else "–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª"
        
        if target_id in ADMIN_IDS:
            await update.message.reply_text("‚ùå –ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
            return
        
        if db.is_banned(target_id):
            await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_id} —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")
            return
        
        db.ban_user(target_id, admin_id, reason)
        db.log_action(admin_id, "ban_user", f"User {target_id}: {reason}")
        
        await update.message.reply_text(
            f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n\n"
            f"ID: {target_id}\n"
            f"–ü—Ä–∏—á–∏–Ω–∞: {reason}"
        )
        
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

async def admin_unban_menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ú–µ–Ω—é —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    if user_id not in ADMIN_IDS:
        return
    
    await query.edit_message_text(
        "‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "/unban 123456789",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')]
        ])
    )

async def unban_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /unban –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"""
    admin_id = update.effective_user.id
    
    if admin_id not in ADMIN_IDS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
        return
    
    args = context.args
    if len(args) < 1:
        await update.message.reply_text(
            "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unban <user_id>"
        )
        return
    
    try:
        target_id = int(args[0])
        
        if not db.is_banned(target_id):
            await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_id} –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")
            return
        
        db.unban_user(target_id)
        db.log_action(admin_id, "unban_user", f"User {target_id}")
        
        await update.message.reply_text(
            f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n\nID: {target_id}"
        )
        
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

async def admin_banned_list_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    if user_id not in ADMIN_IDS:
        return
    
    banned_users = db.get_banned_users()
    
    message = "‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏\n\n"
    
    if banned_users:
        for user in banned_users[:10]:
            name = user['first_name'] or user['username'] or f"ID: {user['user_id']}"
            ban_date = user['banned_date'][:16] if isinstance(user['banned_date'], str) else str(user['banned_date'])[:16]
            message += f"‚Ä¢ {name}\n"
            message += f"  ID: {user['user_id']}\n"
            message += f"  –ü—Ä–∏—á–∏–Ω–∞: {user['ban_reason'] or '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}\n"
            message += f"  –î–∞—Ç–∞: {ban_date}\n\n"
        
        if len(banned_users) > 10:
            message += f"–∏ –µ—â—ë {len(banned_users) - 10} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
    else:
        message += "–ù–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."
    
    keyboard = [
        [InlineKeyboardButton("üî® –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data='admin_ban_menu')],
        [InlineKeyboardButton("‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data='admin_unban_menu')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')]
    ]
    
    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def admin_logs_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–æ–≥–æ–≤"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    if user_id not in ADMIN_IDS:
        return
    
    logs = db.get_all_logs(20)
    
    message = "üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n\n"
    
    if logs:
        for log in logs[:15]:
            timestamp = log['timestamp'][:16] if isinstance(log['timestamp'], str) else str(log['timestamp'])[:16]
            action_icon = {
                'start': 'üöÄ',
                'start_conversion': 'üîÑ',
                'cancel': '‚ùå',
                'ban_user': 'üî®',
                'unban_user': '‚úÖ',
                'accept_privacy': 'üìã',
                'select_conversion': 'üéØ'
            }.get(log['action'], 'üìå')
            
            message += f"{action_icon} {timestamp}\n"
            message += f"  üë§ {log['username']}\n"
            message += f"  üìã {log['action']}"
            if log['details']:
                message += f": {log['details']}"
            message += "\n\n"
    else:
        message += "–õ–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç."
    
    keyboard = [
        [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data='admin_logs')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')]
    ]
    
    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def admin_search_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    if user_id not in ADMIN_IDS:
        return
    
    await query.edit_message_text(
        "üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "/searchuser 123456789\n\n"
        "–ò–ª–∏ username: /searchuser @username",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')]
        ])
    )

async def searchuser_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /searchuser –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    admin_id = update.effective_user.id
    
    if admin_id not in ADMIN_IDS:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
        return
    
    args = context.args
    if len(args) < 1:
        await update.message.reply_text(
            "‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /searchuser <user_id –∏–ª–∏ @username>"
        )
        return
    
    search_term = args[0]
    
    with sqlite3.connect(DB_PATH) as conn:
        cursor = conn.cursor()
        
        if search_term.startswith('@'):
            username = search_term[1:]
            cursor.execute('''
                SELECT user_id, username, first_name, last_name, joined_date, last_activity,
                       total_conversions, total_files, is_banned, ban_reason
                FROM users WHERE username = ?
            ''', (username,))
        else:
            try:
                user_id = int(search_term)
                cursor.execute('''
                    SELECT user_id, username, first_name, last_name, joined_date, last_activity,
                           total_conversions, total_files, is_banned, ban_reason
                    FROM users WHERE user_id = ?
                ''', (user_id,))
            except ValueError:
                await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")
                return
        
        row = cursor.fetchone()
        
        if row:
            cursor.execute('''
                SELECT conversion_type, success, timestamp
                FROM conversions
                WHERE user_id = ?
                ORDER BY timestamp DESC LIMIT 5
            ''', (row[0],))
            conversions = cursor.fetchall()
            
            message = f"""üë§ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

ID: {row[0]}
Username: @{row[1] if row[1] else '–Ω–µ —É–∫–∞–∑–∞–Ω'}
–ò–º—è: {row[2] or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
–§–∞–º–∏–ª–∏—è: {row[3] or '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: {row[4][:16] if row[4] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {row[5][:16] if row[5] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π: {row[6]}
–§–∞–π–ª–æ–≤: {row[7]}
–°—Ç–∞—Ç—É—Å: {'‚õî –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù' if row[8] else '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω'}
"""
            
            if row[8] and row[9]:
                message += f"–ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–∞: {row[9]}\n"
            
            if conversions:
                message += "\n–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:\n"
                for conv in conversions:
                    status = "‚úÖ" if conv[1] else "‚ùå"
                    message += f"{status} {conv[0]} [{conv[2][:16]}]\n"
            
            keyboard = []
            if not row[8]:
                keyboard.append([InlineKeyboardButton("üî® –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f'admin_ban_{row[0]}')])
            else:
                keyboard.append([InlineKeyboardButton("‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data=f'admin_unban_{row[0]}')])
            keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')])
            
            await update.message.reply_text(
                message,
                reply_markup=InlineKeyboardMarkup(keyboard) if keyboard else None
            )
        else:
            await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")

async def admin_panel_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–∑ callback"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    if user_id not in ADMIN_IDS:
        return
    
    keyboard = [
        [InlineKeyboardButton("üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data='admin_stats')],
        [InlineKeyboardButton("üë• –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data='admin_top')],
        [InlineKeyboardButton("üî® –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data='admin_ban_menu')],
        [InlineKeyboardButton("‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", callback_data='admin_unban_menu')],
        [InlineKeyboardButton("‚õî –°–ø–∏—Å–æ–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö", callback_data='admin_banned_list')],
        [InlineKeyboardButton("üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏", callback_data='admin_logs')],
        [InlineKeyboardButton("üîç –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data='admin_search')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data='back_to_menu')]
    ]
    
    await query.edit_message_text(
        "üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ====================

@check_ban
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.effective_user.id
    username = update.effective_user.username
    first_name = update.effective_user.first_name
    last_name = update.effective_user.last_name
    
    db.add_user(user_id, username, first_name, last_name)
    db.log_action(user_id, "start", "–ó–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞")
    
    if user_id not in privacy_accepted:
        keyboard = [[InlineKeyboardButton("‚úÖ –Ø —Å–æ–≥–ª–∞—Å–µ–Ω", callback_data='accept_privacy')]]
        await update.message.reply_text(
            "üìã –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É—è —ç—Ç–æ–≥–æ –±–æ—Ç–∞, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å:\n"
            "‚Ä¢ –§–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–æ –≤—Ä–µ–º—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏\n"
            "‚Ä¢ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è\n"
            "‚Ä¢ –î–∞–Ω–Ω—ã–µ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º\n\n"
            "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return
    
    keyboard = [
        [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
        [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã (TXT‚ÜîPDF)", callback_data='category_documents')],
        [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')],
        [InlineKeyboardButton("üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data='profile')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    
    if user_id in ADMIN_IDS:
        keyboard.append([InlineKeyboardButton("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')])
    
    await update.message.reply_text(
        "üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ñ–∞–π–ª–æ–≤\n\n"
        "–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –≤ —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã.\n\n"
        "üìå –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:\n"
        "‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: JPG, PNG, WebP, GIF\n"
        "‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç—ã: TXT ‚Üî PDF\n"
        "‚Ä¢ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ: GIF‚ÜîMP4, –í–∏–¥–µ–æ‚ÜíMP3/WAV/FLAC\n\n"
        "‚ö†Ô∏è –í–∏–¥–µ–æ ‚Üí GIF: –¥–æ 4 –º–∏–Ω—É—Ç\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

@check_ban
async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    user_id = update.effective_user.id
    db.update_activity(user_id)
    
    keyboard = [
        [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
        [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
        [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')],
        [InlineKeyboardButton("üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data='profile')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data='back_to_menu')]
    ]
    
    message = """üìã –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞

üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:
‚Ä¢ JPG/JPEG ‚Üî PNG ‚Üî WebP ‚Üî GIF
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë
‚Ä¢ –î–æ 5 —Ñ–∞–π–ª–æ–≤ –∑–∞ —Ä–∞–∑
‚Ä¢ –î–ª—è GIF –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä

üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã:
‚Ä¢ TXT ‚Üí PDF (—Ç–µ–∫—Å—Ç –≤ PDF –¥–æ–∫—É–º–µ–Ω—Ç)
‚Ä¢ PDF ‚Üí TXT (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ PDF)
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10 –ú–ë
‚Ä¢ –î–æ 3 —Ñ–∞–π–ª–æ–≤ –∑–∞ —Ä–∞–∑

üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ:
‚Ä¢ GIF ‚Üí MP4 (–∞–Ω–∏–º–∞—Ü–∏—è –≤ –≤–∏–¥–µ–æ)
‚Ä¢ –í–∏–¥–µ–æ ‚Üí GIF (–≤–∏–¥–µ–æ –≤ –∞–Ω–∏–º–∞—Ü–∏—é, –¥–æ 4 –º–∏–Ω—É—Ç)
‚Ä¢ –í–∏–¥–µ–æ ‚Üí MP3/WAV/FLAC (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—É–¥–∏–æ)
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë
‚Ä¢ 1 —Ñ–∞–π–ª –∑–∞ —Ä–∞–∑
‚Ä¢ –û–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è

üë§ –ü—Ä–æ—Ñ–∏–ª—å:
‚Ä¢ /profile - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

üîÑ –ö–æ–º–∞–Ω–¥—ã:
/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help - –ü–æ–º–æ—â—å
/convert - –ù–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é
/profile - –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/cancel - –û—Ç–º–µ–Ω–∞"""
    
    await update.message.reply_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

@check_ban
async def profile_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /profile - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.effective_user.id
    db.update_activity(user_id)
    
    stats = db.get_user_stats(user_id)
    user_info = db.get_user(user_id)
    
    if not stats:
        await update.message.reply_text("‚ùå –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return
    
    joined = stats.get('joined_date', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
    if isinstance(joined, str):
        joined = joined[:16] if len(joined) > 16 else joined
    elif isinstance(joined, datetime):
        joined = joined.strftime('%Y-%m-%d %H:%M')
    
    last_active = stats.get('last_activity', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
    if isinstance(last_active, str):
        last_active = last_active[:16] if len(last_active) > 16 else last_active
    elif isinstance(last_active, datetime):
        last_active = last_active.strftime('%Y-%m-%d %H:%M')
    
    status = "‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" if user_info and user_info['is_banned'] else "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω"
    
    message = f"""üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å

üÜî ID: {user_id}
üìä –°—Ç–∞—Ç—É—Å: {status}
üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π: {stats.get('total_conversions', 0)}
üìÅ –§–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {stats.get('total_files', 0)}
üìÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {joined}
üïê –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {last_active}
"""
    
    if user_info and user_info['is_banned'] and user_info['ban_reason']:
        message += f"\n‚õî –ü—Ä–∏—á–∏–Ω–∞ –±–∞–Ω–∞: {user_info['ban_reason']}"
    
    keyboard = [
        [InlineKeyboardButton("üîÑ –ù–æ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è", callback_data='back_to_menu')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    
    await update.message.reply_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

@check_ban
async def convert_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /convert - –Ω–∞—á–∞–ª–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
    user_id = update.effective_user.id
    db.update_activity(user_id)
    
    async with user_data_lock:
        if user_id not in user_data:
            await update.message.reply_text(
                "‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã.",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
                    [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
                    [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')]
                ])
            )
            return
        
        user_info = user_data[user_id]
    
    if len(user_info['files']) == 0:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.")
        return
    
    db.log_action(user_id, "start_conversion", f"{user_info['source']}->{user_info['target']}")
    await start_conversion(update, user_info, user_id)

@check_ban
async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /cancel - –æ—Ç–º–µ–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏"""
    user_id = update.effective_user.id
    db.update_activity(user_id)
    
    async with user_data_lock:
        if user_id in user_data:
            del user_data[user_id]
    
    async with processing_files_lock:
        if user_id in processing_files:
            del processing_files[user_id]
    
    db.log_action(user_id, "cancel", "–û—Ç–º–µ–Ω–∏–ª –æ–ø–µ—Ä–∞—Ü–∏—é")
    await update.message.reply_text("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ –º–µ–Ω—é.")

# ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–û–ö ====================

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    db.update_activity(user_id)
    
    if db.is_banned(user_id):
        await query.edit_message_text(
            "‚õî –î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n\n"
            "–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
        )
        return
    
    # ===== –ê–î–ú–ò–ù –ö–ù–û–ü–ö–ò =====
    if user_id in ADMIN_IDS:
        if query.data == 'admin_panel':
            await admin_panel_callback(update, context)
            return
        elif query.data == 'admin_stats':
            await admin_stats_handler(update, context)
            return
        elif query.data == 'admin_top':
            await admin_top_handler(update, context)
            return
        elif query.data == 'admin_ban_menu':
            await admin_ban_menu_handler(update, context)
            return
        elif query.data == 'admin_unban_menu':
            await admin_unban_menu_handler(update, context)
            return
        elif query.data == 'admin_banned_list':
            await admin_banned_list_handler(update, context)
            return
        elif query.data == 'admin_logs':
            await admin_logs_handler(update, context)
            return
        elif query.data == 'admin_search':
            await admin_search_handler(update, context)
            return
        
        if query.data.startswith('admin_ban_'):
            target_id = int(query.data.split('_')[2])
            await quick_ban_user(query, user_id, target_id)
            return
        elif query.data.startswith('admin_unban_'):
            target_id = int(query.data.split('_')[2])
            await quick_unban_user(query, user_id, target_id)
            return
    
    # ===== –û–ë–©–ò–ï –ö–ù–û–ü–ö–ò =====
    if query.data == 'accept_privacy':
        privacy_accepted[user_id] = True
        db.log_action(user_id, "accept_privacy", "–ü—Ä–∏–Ω—è–ª –ø–æ–ª–∏—Ç–∏–∫—É")
        await start_from_query(query, user_id)
    
    elif query.data == 'help':
        await help_command_from_query(query)
    
    elif query.data == 'profile':
        await profile_from_query(query, user_id)
    
    elif query.data == 'back_to_menu':
        await show_main_menu_from_query(query, user_id)
    
    elif query.data == 'back_to_category':
        await back_to_category(query, user_id)
    
    # ===== –ö–ê–¢–ï–ì–û–†–ò–ò =====
    elif query.data == 'category_images':
        await show_image_categories(query)
    
    elif query.data == 'category_documents':
        await show_document_formats(query)
    
    elif query.data == 'category_video':
        await show_video_categories(query)
    
    # ===== –í–ò–î–ï–û/–ê–£–î–ò–û =====
    elif query.data == 'video_conversion':
        await show_video_conversion_formats(query)
    
    elif query.data == 'audio_extraction':
        await show_audio_extraction_formats(query)
    
    # ===== –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø =====
    elif query.data == 'jpg_category':
        await show_jpg_formats(query)
    elif query.data == 'png_category':
        await show_png_formats(query)
    elif query.data == 'webp_category':
        await show_webp_formats(query)
    elif query.data == 'GIF_category':
        await show_GIF_formats(query)
    
    # ===== –î–û–ö–£–ú–ï–ù–¢–´ =====
    elif query.data == 'doc_category':
        await show_document_conversion_formats(query)
    
    # ===== –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø =====
    elif query.data == 'start_conversion':
        await start_conversion_from_button(query, user_id)
    
    # ===== –§–û–†–ú–ê–¢–´ –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò =====
    else:
        conversion_map = {
            # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            'jpg_to_png': ('jpg', 'png', 20, 'üñºÔ∏è', 5, 'JPG ‚Üí PNG'),
            'jpg_to_webp': ('jpg', 'webp', 20, 'üñºÔ∏è', 5, 'JPG ‚Üí WebP'),
            'jpg_to_GIF': ('jpg', 'GIF', 20, 'üñºÔ∏è', 5, 'JPG ‚Üí GIF'),
            'png_to_jpg': ('png', 'jpg', 20, 'üñºÔ∏è', 5, 'PNG ‚Üí JPG'),
            'png_to_webp': ('png', 'webp', 20, 'üñºÔ∏è', 5, 'PNG ‚Üí WebP'),
            'png_to_GIF': ('png', 'GIF', 20, 'üñºÔ∏è', 5, 'PNG ‚Üí GIF'),
            'webp_to_jpg': ('webp', 'jpg', 20, 'üñºÔ∏è', 5, 'WebP ‚Üí JPG'),
            'webp_to_png': ('webp', 'png', 20, 'üñºÔ∏è', 5, 'WebP ‚Üí PNG'),
            'webp_to_GIF': ('webp', 'GIF', 20, 'üñºÔ∏è', 5, 'WebP ‚Üí GIF'),
            'GIF_to_jpg': ('GIF', 'jpg', 20, 'üñºÔ∏è', 5, 'GIF ‚Üí JPG'),
            'GIF_to_png': ('GIF', 'png', 20, 'üñºÔ∏è', 5, 'GIF ‚Üí PNG'),
            'GIF_to_webp': ('GIF', 'webp', 20, 'üñºÔ∏è', 5, 'GIF ‚Üí WebP'),
            
            # –î–æ–∫—É–º–µ–Ω—Ç—ã
            'txt_to_pdf': ('txt', 'pdf', 10, 'üìÑ', 3, 'TXT ‚Üí PDF'),
            'pdf_to_txt': ('pdf', 'txt', 10, 'üìù', 3, 'PDF ‚Üí TXT'),
            
            # –í–∏–¥–µ–æ/–ê—É–¥–∏–æ
            'GIF_to_mp4': ('GIF', 'mp4', 50, 'üé¨', 1, 'GIF ‚Üí MP4'),
            'mp4_to_GIF': ('video', 'GIF', 50, 'üé¨', 1, 'MP4 ‚Üí GIF (–¥–æ 4 –º–∏–Ω)'),
            'video_to_mp3': ('video', 'mp3', 50, 'üéµ', 1, '–í–∏–¥–µ–æ ‚Üí MP3'),
            'video_to_wav': ('video', 'wav', 50, 'üéµ', 1, '–í–∏–¥–µ–æ ‚Üí WAV'),
            'video_to_flac': ('video', 'flac', 50, 'üéµ', 1, '–í–∏–¥–µ–æ ‚Üí FLAC'),
        }
        
        if query.data in conversion_map:
            await setup_conversion(query, user_id, query.data, conversion_map)

async def quick_ban_user(query, admin_id: int, target_id: int):
    """–ë—ã—Å—Ç—Ä–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if target_id in ADMIN_IDS:
        await query.edit_message_text("‚ùå –ù–µ–ª—å–∑—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
        return
    
    if db.is_banned(target_id):
        await query.edit_message_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_id} —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")
        return
    
    db.ban_user(target_id, admin_id, "–ë—ã—Å—Ç—Ä–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏")
    db.log_action(admin_id, "ban_user", f"User {target_id}: –ë—ã—Å—Ç—Ä–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞")
    
    await query.edit_message_text(
        f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n\nID: {target_id}\n–ü—Ä–∏—á–∏–Ω–∞: –ë—ã—Å—Ç—Ä–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')]
        ])
    )

async def quick_unban_user(query, admin_id: int, target_id: int):
    """–ë—ã—Å—Ç—Ä–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not db.is_banned(target_id):
        await query.edit_message_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_id} –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")
        return
    
    db.unban_user(target_id)
    db.log_action(admin_id, "unban_user", f"User {target_id}: –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞")
    
    await query.edit_message_text(
        f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\n\nID: {target_id}",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –∞–¥–º–∏–Ω–∫—É", callback_data='admin_panel')]
        ])
    )

async def start_from_query(query, user_id: int):
    """–°—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é –ø–æ—Å–ª–µ –ø—Ä–∏–Ω—è—Ç–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏"""
    keyboard = [
        [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
        [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã (TXT‚ÜîPDF)", callback_data='category_documents')],
        [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')],
        [InlineKeyboardButton("üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data='profile')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    
    if user_id in ADMIN_IDS:
        keyboard.append([InlineKeyboardButton("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')])
    
    await query.edit_message_text(
        "üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ñ–∞–π–ª–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def help_command_from_query(query):
    """–ü–æ–º–æ—â—å –∏–∑ callback"""
    keyboard = [
        [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
        [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
        [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data='back_to_menu')]
    ]
    
    message = """üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:

üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:
‚Ä¢ JPG/JPEG ‚Üî PNG ‚Üî WebP ‚Üî GIF
‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: 20 –ú–ë, –¥–æ 5 —Ñ–∞–π–ª–æ–≤
‚Ä¢ –î–ª—è GIF –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä

üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã:
‚Ä¢ TXT ‚Üí PDF
‚Ä¢ PDF ‚Üí TXT (–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: 10 –ú–ë, –¥–æ 3 —Ñ–∞–π–ª–æ–≤

üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ:
‚Ä¢ GIF ‚Üî MP4
‚Ä¢ –í–∏–¥–µ–æ ‚Üí GIF (–¥–æ 4 –º–∏–Ω—É—Ç)
‚Ä¢ –í–∏–¥–µ–æ ‚Üí MP3/WAV/FLAC
‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: 50 –ú–ë, 1 —Ñ–∞–π–ª
‚Ä¢ –û–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è"""
    
    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def profile_from_query(query, user_id: int):
    """–ü—Ä–æ—Ñ–∏–ª—å –∏–∑ callback"""
    stats = db.get_user_stats(user_id)
    user_info = db.get_user(user_id)
    
    joined = stats.get('joined_date', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
    if isinstance(joined, str):
        joined = joined[:16] if len(joined) > 16 else joined
    
    last_active = stats.get('last_activity', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
    if isinstance(last_active, str):
        last_active = last_active[:16] if len(last_active) > 16 else last_active
    
    status = "‚õî –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" if user_info and user_info['is_banned'] else "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω"
    
    message = f"""üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å

üÜî ID: {user_id}
üìä –°—Ç–∞—Ç—É—Å: {status}
üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π: {stats.get('total_conversions', 0)}
üìÅ –§–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {stats.get('total_files', 0)}
üìÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: {joined}
üïê –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: {last_active}
"""
    
    keyboard = [
        [InlineKeyboardButton("üîÑ –ù–æ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è", callback_data='back_to_menu')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    
    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_main_menu_from_query(query, user_id: int):
    """–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏–∑ callback"""
    keyboard = [
        [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
        [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã (TXT‚ÜîPDF)", callback_data='category_documents')],
        [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')],
        [InlineKeyboardButton("üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data='profile')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    
    if user_id in ADMIN_IDS:
        keyboard.append([InlineKeyboardButton("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')])
    
    await query.edit_message_text(
        "üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ñ–∞–π–ª–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def back_to_category(query, user_id: int):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
    async with user_data_lock:
        if user_id in user_data:
            conv_type = user_data[user_id].get('type', '')
            
            if 'jpg' in conv_type or 'png' in conv_type or 'webp' in conv_type or 'GIF' in conv_type:
                await show_image_categories(query)
            elif 'txt' in conv_type or 'pdf' in conv_type:
                await show_document_formats(query)
            elif 'video' in conv_type or 'mp4' in conv_type or 'GIF_to_mp4' in conv_type:
                await show_video_categories(query)
            else:
                await show_main_menu_from_query(query, user_id)
        else:
            await show_main_menu_from_query(query, user_id)

# ==================== –ú–ï–ù–Æ –ö–ê–¢–ï–ì–û–†–ò–ô ====================

async def show_image_categories(query):
    """–ú–µ–Ω—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è JPG/JPEG —Ñ–∞–π–ª—ã", callback_data='jpg_category')],
        [InlineKeyboardButton("üñºÔ∏è PNG —Ñ–∞–π–ª—ã", callback_data='png_category')],
        [InlineKeyboardButton("üñºÔ∏è WebP —Ñ–∞–π–ª—ã", callback_data='webp_category')],
        [InlineKeyboardButton("üñºÔ∏è GIF —Ñ–∞–π–ª—ã", callback_data='GIF_category')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data='back_to_menu')]
    ]
    await query.edit_message_text(
        "üì∏ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:\n"
        "‚Ä¢ JPG/JPEG\n"
        "‚Ä¢ PNG\n"
        "‚Ä¢ WebP\n"
        "‚Ä¢ GIF\n\n"
        "üìè –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 20 –ú–ë\n"
        "üì¶ –î–æ 5 —Ñ–∞–π–ª–æ–≤ –∑–∞ —Ä–∞–∑\n\n"
        "‚ö†Ô∏è –î–ª—è GIF –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_document_formats(query):
    """–ú–µ–Ω—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    keyboard = [
        [InlineKeyboardButton("üìÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤", callback_data='doc_category')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data='back_to_menu')]
    ]
    await query.edit_message_text(
        "üìÑ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –î–æ–∫—É–º–µ–Ω—Ç—ã\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:\n\n"
        "üìù TXT ‚Üí PDF\n"
        "‚Ä¢ –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –≤ PDF –¥–æ–∫—É–º–µ–Ω—Ç\n"
        "‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ\n\n"
        "üìÑ PDF ‚Üí TXT\n"
        "‚Ä¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ PDF —Ñ–∞–π–ª–µ\n\n"
        "üìè –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10 –ú–ë\n"
        "üì¶ –î–æ 3 —Ñ–∞–π–ª–æ–≤ –∑–∞ —Ä–∞–∑",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_document_conversion_formats(query):
    """–ú–µ–Ω—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    keyboard = [
        [InlineKeyboardButton("üìù TXT ‚Üí PDF", callback_data='txt_to_pdf')],
        [InlineKeyboardButton("üìÑ PDF ‚Üí TXT", callback_data='pdf_to_txt')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º", callback_data='category_documents')]
    ]
    await query.edit_message_text(
        "üìÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_video_categories(query):
    """–ú–µ–Ω—é –≤–∏–¥–µ–æ/–∞—É–¥–∏–æ"""
    keyboard = [
        [InlineKeyboardButton("üé¨ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∏–¥–µ–æ (GIF‚ÜîMP4)", callback_data='video_conversion')],
        [InlineKeyboardButton("üéµ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—É–¥–∏–æ (–í–∏–¥–µ–æ‚ÜíMP3/WAV/FLAC)", callback_data='audio_extraction')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data='back_to_menu')]
    ]
    
    message = """üé¨ –ö–∞—Ç–µ–≥–æ—Ä–∏—è: –í–∏–¥–µ–æ/–ê—É–¥–∏–æ

–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:

üé¨ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∏–¥–µ–æ:
‚Ä¢ GIF ‚Üí MP4
‚Ä¢ –í–∏–¥–µ–æ ‚Üí GIF (–¥–æ 4 –º–∏–Ω—É—Ç)

üéµ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—É–¥–∏–æ:
‚Ä¢ –í–∏–¥–µ–æ ‚Üí MP3 (—Å–∂–∞—Ç–∏–µ)
‚Ä¢ –í–∏–¥–µ–æ ‚Üí WAV (–±–µ–∑ —Å–∂–∞—Ç–∏—è)
‚Ä¢ –í–∏–¥–µ–æ ‚Üí FLAC (–±–µ–∑ –ø–æ—Ç–µ—Ä—å)

‚ö†Ô∏è –û–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è:
‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 50 –ú–ë
‚Ä¢ –¢–æ–ª—å–∫–æ 1 —Ñ–∞–π–ª –∑–∞ —Ä–∞–∑
‚Ä¢ –ú–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 3 –º–∏–Ω—É—Ç"""
    
    await query.edit_message_text(
        message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_video_conversion_formats(query):
    """–ú–µ–Ω—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤–∏–¥–µ–æ"""
    keyboard = [
        [InlineKeyboardButton("üé¨ GIF ‚Üí MP4", callback_data='GIF_to_mp4')],
        [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ ‚Üí GIF (–¥–æ 4 –º–∏–Ω)", callback_data='mp4_to_GIF')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –≤–∏–¥–µ–æ", callback_data='category_video')]
    ]
    await query.edit_message_text(
        "üé¨ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∏–¥–µ–æ\n\n"
        "GIF ‚Üí MP4\n"
        "‚Ä¢ –ê–Ω–∏–º–∞—Ü–∏—è –≤ –≤–∏–¥–µ–æ\n"
        "‚Ä¢ –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞\n\n"
        "–í–∏–¥–µ–æ ‚Üí GIF\n"
        "‚Ä¢ –í–∏–¥–µ–æ –≤ –∞–Ω–∏–º–∞—Ü–∏—é\n"
        "‚Ä¢ –ú–∞–∫—Å. –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 4 –º–∏–Ω—É—Ç—ã (240 —Å–µ–∫)\n\n"
        "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_audio_extraction_formats(query):
    """–ú–µ–Ω—é –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∞—É–¥–∏–æ"""
    keyboard = [
        [InlineKeyboardButton("üéµ MP3 (—Å–∂–∞—Ç–∏–µ)", callback_data='video_to_mp3')],
        [InlineKeyboardButton("üéµ WAV (–±–µ–∑ —Å–∂–∞—Ç–∏—è)", callback_data='video_to_wav')],
        [InlineKeyboardButton("üéµ FLAC (–±–µ–∑ –ø–æ—Ç–µ—Ä—å)", callback_data='video_to_flac')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –≤–∏–¥–µ–æ", callback_data='category_video')]
    ]
    await query.edit_message_text(
        "üéµ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—É–¥–∏–æ –∏–∑ –≤–∏–¥–µ–æ\n\n"
        "MP3 - —Ö–æ—Ä–æ—à–µ–µ —Å–∂–∞—Ç–∏–µ, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π\n"
        "WAV - –±–µ–∑ —Å–∂–∞—Ç–∏—è, –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ\n"
        "FLAC - —Å–∂–∞—Ç–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä—å\n\n"
        "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_jpg_formats(query):
    """–ú–µ–Ω—é JPG —Ñ–æ—Ä–º–∞—Ç–æ–≤"""
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è JPG ‚Üí PNG", callback_data='jpg_to_png')],
        [InlineKeyboardButton("üñºÔ∏è JPG ‚Üí WebP", callback_data='jpg_to_webp')],
        [InlineKeyboardButton("üñºÔ∏è JPG ‚Üí GIF", callback_data='jpg_to_GIF')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º", callback_data='category_images')]
    ]
    await query.edit_message_text(
        "üñºÔ∏è –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: JPG/JPEG\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_png_formats(query):
    """–ú–µ–Ω—é PNG —Ñ–æ—Ä–º–∞—Ç–æ–≤"""
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è PNG ‚Üí JPG", callback_data='png_to_jpg')],
        [InlineKeyboardButton("üñºÔ∏è PNG ‚Üí WebP", callback_data='png_to_webp')],
        [InlineKeyboardButton("üñºÔ∏è PNG ‚Üí GIF", callback_data='png_to_GIF')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º", callback_data='category_images')]
    ]
    await query.edit_message_text(
        "üñºÔ∏è –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: PNG\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_webp_formats(query):
    """–ú–µ–Ω—é WebP —Ñ–æ—Ä–º–∞—Ç–æ–≤"""
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è WebP ‚Üí JPG", callback_data='webp_to_jpg')],
        [InlineKeyboardButton("üñºÔ∏è WebP ‚Üí PNG", callback_data='webp_to_png')],
        [InlineKeyboardButton("üñºÔ∏è WebP ‚Üí GIF", callback_data='webp_to_GIF')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º", callback_data='category_images')]
    ]
    await query.edit_message_text(
        "üñºÔ∏è –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: WebP\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def show_GIF_formats(query):
    """–ú–µ–Ω—é GIF —Ñ–æ—Ä–º–∞—Ç–æ–≤"""
    keyboard = [
        [InlineKeyboardButton("üñºÔ∏è GIF ‚Üí JPG", callback_data='GIF_to_jpg')],
        [InlineKeyboardButton("üñºÔ∏è GIF ‚Üí PNG", callback_data='GIF_to_png')],
        [InlineKeyboardButton("üñºÔ∏è GIF ‚Üí WebP", callback_data='GIF_to_webp')],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º", callback_data='category_images')]
    ]
    await query.edit_message_text(
        "üñºÔ∏è –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: GIF\n\n"
        "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def setup_conversion(query, user_id: int, callback_data: str, conversion_map: Dict):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
    source, target, max_mb, emoji, max_files, display_name = conversion_map[callback_data]
    
    if callback_data in ['GIF_to_mp4', 'mp4_to_GIF', 'video_to_mp3', 'video_to_wav', 'video_to_flac']:
        max_mb = 50  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 50 –ú–ë –¥–ª—è –≤–∏–¥–µ–æ
        max_files = 1
    
    async with user_data_lock:
        user_data[user_id] = {
            'type': callback_data,
            'source': source,
            'target': target,
            'max_size': max_mb * 1024 * 1024,
            'max_files': max_files,
            'files': [],
            'status_message': None
        }
    
    format_names = {
        'jpg': 'JPG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
        'png': 'PNG –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
        'webp': 'WebP –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
        'GIF': 'GIF –∞–Ω–∏–º–∞—Ü–∏—è',
        'txt': '—Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª',
        'pdf': 'PDF –¥–æ–∫—É–º–µ–Ω—Ç',
        'mp4': 'MP4 –≤–∏–¥–µ–æ',
        'video': '–≤–∏–¥–µ–æ —Ñ–∞–π–ª',
        'mp3': 'MP3 –∞—É–¥–∏–æ',
        'wav': 'WAV –∞—É–¥–∏–æ',
        'flac': 'FLAC –∞—É–¥–∏–æ'
    }
    
    files_text = f"–ú–∞–∫—Å–∏–º—É–º —Ñ–∞–π–ª–æ–≤: {max_files}" if max_files > 1 else "–¢–æ–ª—å–∫–æ 1 —Ñ–∞–π–ª"
    warning_text = ""
    api_warning = ""
    
    if callback_data in ['GIF_to_jpg', 'GIF_to_png', 'GIF_to_webp']:
        warning_text = "\n‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä GIF"
    elif callback_data in ['GIF_to_mp4', 'mp4_to_GIF', 'video_to_mp3', 'video_to_wav', 'video_to_flac']:
        api_warning = "\nüåê –û–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è\n‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: 50 –ú–ë\n‚Ä¢ –í–∏–¥–µ–æ ‚Üí GIF: –¥–æ 4 –º–∏–Ω—É—Ç\n‚Ä¢ –ú–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 3 –º–∏–Ω—É—Ç"
    
    await query.edit_message_text(
        f"{emoji} {display_name}\n\n"
        f"üì§ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª(—ã) .{source}\n"
        f"üìè –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: {max_mb} –ú–ë\n"
        f"üì¶ {files_text}\n\n"
        f"üìã –¢–∏–ø: {format_names.get(source, source)}\n"
        f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: {format_names.get(target, target)}"
        f"{warning_text}{api_warning}\n\n"
        f"üí° –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:\n"
        f"1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã\n"
        f"2. –ö–æ–≥–¥–∞ –≥–æ—Ç–æ–≤—ã, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /convert\n"
        f"3. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ 'üöÄ –ù–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é'\n\n"
        f"‚ùå –û—Ç–º–µ–Ω–∞: /cancel",
        reply_markup=InlineKeyboardMarkup([
            [InlineKeyboardButton("üöÄ –ù–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é", callback_data='start_conversion')],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_category')]
        ])
    )
    
    db.log_action(user_id, "select_conversion", f"{source}->{target}")

async def start_conversion_from_button(query, user_id: int):
    """–ù–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –∏–∑ –∫–Ω–æ–ø–∫–∏"""
    async with user_data_lock:
        if user_id not in user_data:
            await query.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã!", show_alert=True)
            return
        
        if len(user_data[user_id]['files']) == 0:
            await query.answer("‚ùå –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã!", show_alert=True)
            return
    
    await query.edit_message_text("üöÄ –ù–∞—á–∏–Ω–∞—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é...")
    await start_conversion_from_query(query, user_id)

async def start_conversion_from_query(query, user_id: int):
    """–ó–∞–ø—É—Å–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑ query"""
    async with user_data_lock:
        user_info = user_data[user_id]
    
    await process_conversion(user_info, user_id, query.message.chat_id, query.message.message_id)

async def start_conversion(update: Update, user_info: Dict, user_id: int):
    """–ó–∞–ø—É—Å–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏–∑ –∫–æ–º–∞–Ω–¥—ã"""
    await process_conversion(user_info, user_id, update.message.chat_id, update.message.message_id)

# ==================== –ü–†–û–¶–ï–°–° –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò ====================

async def update_progress(user_id: int, current: int, total: int, progress: int, status_msg=None):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
    async with processing_files_lock:
        if user_id in processing_files:
            processing_files[user_id]['progress'] = progress
            processing_files[user_id]['current_file'] = current
            processing_files[user_id]['total_files'] = total
    
    if status_msg:
        progress_bar = "üü©" * int(progress / 10) + "‚¨ú" * (10 - int(progress / 10))
        try:
            await status_msg.edit_text(
                f"üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ {current}/{total}\n\n"
                f"{progress_bar} {progress}%\n\n"
                f"‚è≥ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ..."
            )
        except:
            pass

async def show_progress_bar(message, current: int, total: int, text: str = ""):
    """–ü–æ–∫–∞–∑ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞"""
    try:
        progress = int((current / total) * 100) if total > 0 else 0
        progress_bar = "üü©" * int(progress / 10) + "‚¨ú" * (10 - int(progress / 10))
        await message.edit_text(
            f"üîÑ {text}\n\n{progress_bar} {progress}%\n\nüìä –ü—Ä–æ–≥—Ä–µ—Å—Å: {current}/{total}"
        )
    except:
        pass

async def process_conversion(user_info: Dict, user_id: int, chat_id: int, message_id: int):
    """–û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
    total_files = len(user_info['files'])
    start_time = time.time()
    
    if total_files == 0:
        return
    
    status_msg = await application.bot.send_message(
        chat_id=chat_id,
        text="üîÑ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–æ–≤..."
    )
    
    async with processing_files_lock:
        processing_files[user_id] = {
            'progress': 0,
            'current_file': 1,
            'total_files': total_files
        }
    
    try:
        converted_files = []
        success_count = 0
        
        for idx, file_info in enumerate(user_info['files'], 1):
            try:
                await show_progress_bar(status_msg, idx-1, total_files, "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...")
                
                file = await application.bot.get_file(file_info['file_id'])
                file_bytes = await file.download_as_bytearray()
                
                if len(file_bytes) > user_info['max_size']:
                    max_mb = user_info['max_size'] // (1024 * 1024)
                    raise Exception(f"–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º: {max_mb} –ú–ë")
                
                await show_progress_bar(status_msg, idx-1, total_files, "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞...")
                
                source_ext = user_info['source']
                target_ext = user_info['target']
                conv_type = user_info['type']
                original_name = file_info['file_name']
                
                detected_type = detect_file_type(bytes(file_bytes), original_name)
                logger.info(f"–§–∞–π–ª {original_name}: –æ–∂–∏–¥–∞–µ–º—ã–π {source_ext}, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω {detected_type}")
                
                # ===== –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô =====
                if source_ext in ['jpg', 'jpeg', 'png', 'webp', 'GIF']:
                    if source_ext == 'GIF' and detected_type != 'GIF':
                        raise Exception(f"–§–∞–π–ª {original_name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è GIF.")
                    elif source_ext in ['jpg', 'jpeg'] and detected_type not in ['jpg', 'jpeg']:
                        raise Exception(f"–§–∞–π–ª {original_name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è JPG/JPEG.")
                    elif source_ext == 'png' and detected_type != 'png':
                        raise Exception(f"–§–∞–π–ª {original_name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è PNG.")
                    elif source_ext == 'webp' and detected_type != 'webp':
                        raise Exception(f"–§–∞–π–ª {original_name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è WebP.")
                    
                    converted_bytes = await convert_image(bytes(file_bytes), source_ext, target_ext)
                    
                    name_without_ext = original_name.rsplit('.', 1)[0] if '.' in original_name else original_name
                    new_filename = f"{name_without_ext}_converted.{target_ext}"
                    
                    mime_types = {
                        'jpg': 'image/jpeg',
                        'png': 'image/png',
                        'webp': 'image/webp',
                        'GIF': 'image/gif'
                    }
                    
                    converted_files.append({
                        'bytes': converted_bytes,
                        'filename': new_filename,
                        'mime_type': mime_types.get(target_ext, f'image/{target_ext}')
                    })
                    success_count += 1
                
                # ===== –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –î–û–ö–£–ú–ï–ù–¢–û–í =====
                elif conv_type == 'txt_to_pdf':
                    if detected_type != 'txt':
                        raise Exception(f"–§–∞–π–ª {original_name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Ñ–∞–π–ª–æ–º.")
                    
                    txt_content = bytes(file_bytes).decode('utf-8', errors='ignore')
                    converted_bytes = await convert_txt_to_pdf(txt_content)
                    
                    name_without_ext = original_name.rsplit('.', 1)[0] if '.' in original_name else original_name
                    new_filename = f"{name_without_ext}_converted.pdf"
                    
                    converted_files.append({
                        'bytes': converted_bytes,
                        'filename': new_filename,
                        'mime_type': 'application/pdf'
                    })
                    success_count += 1
                
                elif conv_type == 'pdf_to_txt':
                    if detected_type != 'pdf':
                        raise Exception(f"–§–∞–π–ª {original_name} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è PDF.")
                    
                    txt_content = await convert_pdf_to_txt(bytes(file_bytes))
                    converted_bytes = txt_content.encode('utf-8')
                    
                    name_without_ext = original_name.rsplit('.', 1)[0] if '.' in original_name else original_name
                    new_filename = f"{name_without_ext}_info.txt"
                    
                    converted_files.append({
                        'bytes': converted_bytes,
                        'filename': new_filename,
                        'mime_type': 'text/plain'
                    })
                    success_count += 1
                
                # ===== –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –í–ò–î–ï–û =====
                elif conv_type in ['GIF_to_mp4', 'mp4_to_GIF', 'video_to_mp3', 'video_to_wav', 'video_to_flac']:
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ GIF
                    if conv_type == 'mp4_to_GIF' and hasattr(file_info, 'duration'):
                        duration = file_info.get('duration', 0)
                        if duration > MAX_GIF_DURATION:
                            raise Exception(f"–í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ GIF. –ú–∞–∫—Å–∏–º—É–º: {MAX_GIF_DURATION} —Å–µ–∫ ({MAX_GIF_DURATION/60:.0f} –º–∏–Ω)")
                    
                    await show_progress_bar(status_msg, idx, total_files, "–û–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è...")
                    
                    converted_data = await convert_video_via_api(
                        bytes(file_bytes), 
                        conv_type, 
                        original_name
                    )
                    converted_files.append(converted_data)
                    success_count += 1
                
                await show_progress_bar(status_msg, idx, total_files, "–§–∞–π–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω")
                
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ {idx}: {e}")
                await status_msg.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞ {idx}: {str(e)[:150]}")
        
        # ===== –û–¢–ü–†–ê–í–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í =====
        if converted_files:
            sent_count = 0
            for converted_file in converted_files:
                try:
                    mime_type = converted_file['mime_type']
                    
                    if mime_type.startswith('image/'):
                        await application.bot.send_photo(
                            chat_id=chat_id,
                            photo=converted_file['bytes'],
                            caption=f"‚úÖ {converted_file['filename']}"
                        )
                    elif mime_type.startswith('audio/'):
                        await application.bot.send_audio(
                            chat_id=chat_id,
                            audio=converted_file['bytes'],
                            title=converted_file['filename'],
                            filename=converted_file['filename']
                        )
                    elif mime_type.startswith('video/'):
                        await application.bot.send_video(
                            chat_id=chat_id,
                            video=converted_file['bytes'],
                            caption=f"‚úÖ {converted_file['filename']}"
                        )
                    else:
                        await application.bot.send_document(
                            chat_id=chat_id,
                            document=converted_file['bytes'],
                            filename=converted_file['filename']
                        )
                    
                    sent_count += 1
                    
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞: {e}")
                    await status_msg.reply_text(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª: {str(e)[:100]}")
            
            duration = int((time.time() - start_time) * 1000)
            db.log_conversion(
                user_id,
                user_info['type'],
                user_info['source'],
                user_info['target'],
                sum(len(f.get('bytes', b'')) for f in converted_files),
                True,
                duration=duration
            )
            
            await status_msg.edit_text(
                f"‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n"
                f"üìä –£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {sent_count}/{total_files} —Ñ–∞–π–ª–æ–≤\n"
                f"üìÅ –§–æ—Ä–º–∞—Ç: {user_info['source'].upper()} ‚Üí {user_info['target'].upper()}\n"
                f"‚è± –í—Ä–µ–º—è: {duration/1000:.1f} —Å–µ–∫"
            )
            
            await show_main_menu_after_conversion(chat_id, user_id)
        else:
            await status_msg.edit_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ñ–∞–π–ª—ã.")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–æ–≤: {e}")
        await status_msg.edit_text(f"‚ùå –û—à–∏–±–∫–∞: {str(e)[:200]}")
        
        db.log_conversion(
            user_id,
            user_info['type'],
            user_info['source'],
            user_info['target'],
            0,
            False,
            str(e)[:200],
            int((time.time() - start_time) * 1000)
        )
    
    finally:
        async with processing_files_lock:
            if user_id in processing_files:
                del processing_files[user_id]
        async with user_data_lock:
            if user_id in user_data:
                del user_data[user_id]

async def show_main_menu_after_conversion(chat_id: int, user_id: int):
    """–ü–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –ø–æ—Å–ª–µ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
    keyboard = [
        [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
        [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã (TXT‚ÜîPDF)", callback_data='category_documents')],
        [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')],
        [InlineKeyboardButton("üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å", callback_data='profile')],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data='help')]
    ]
    
    if user_id in ADMIN_IDS:
        keyboard.append([InlineKeyboardButton("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')])
    
    await application.bot.send_message(
        chat_id=chat_id,
        text="üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä —Ñ–∞–π–ª–æ–≤\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ê–ô–õ–û–í ====================

@check_ban
async def handle_documents(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"""
    user_id = update.effective_user.id
    db.update_activity(user_id)
    
    async with user_data_lock:
        if user_id not in user_data:
            keyboard = [
                [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
                [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
                [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')]
            ]
            await update.message.reply_text(
                "‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é.",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
            return
        
        user_info = user_data[user_id]
    
    if len(user_info['files']) >= user_info['max_files']:
        await update.message.reply_text(
            f"‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º {user_info['max_files']} —Ñ–∞–π–ª–æ–≤.\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ /convert –¥–ª—è –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏."
        )
        return
    
    if update.message.document:
        document = update.message.document
        
        if document.file_size and document.file_size > user_info['max_size']:
            max_mb = user_info['max_size'] // (1024 * 1024)
            await update.message.reply_text(f"‚ùå –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º: {max_mb} –ú–ë.")
            return
        
        file_name = document.file_name.lower() if document.file_name else "document"
        source_ext = user_info['source']
        
        allowed_extensions = {
            'jpg': ['.jpg', '.jpeg', '.jpe', '.jfif'],
            'png': ['.png'],
            'webp': ['.webp'],
            'GIF': ['.gif'],
            'txt': ['.txt', '.text'],
            'pdf': ['.pdf'],
            'video': ['.mp4', '.avi', '.mov', '.mkv', '.webm', '.flv', '.wmv']
        }
        
        if source_ext in allowed_extensions:
            if not any(file_name.endswith(ext) for ext in allowed_extensions[source_ext]):
                await update.message.reply_text(
                    f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –û–∂–∏–¥–∞–µ—Ç—Å—è: {', '.join(allowed_extensions[source_ext])}"
                )
                return
        
        # –î–ª—è –≤–∏–¥–µ–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        if source_ext == 'video' and user_info['type'] == 'mp4_to_GIF':
            duration = 0
            if hasattr(document, 'duration') and document.duration:
                duration = document.duration
            elif hasattr(update.message.video, 'duration') and update.message.video:
                duration = update.message.video.duration
            
            if duration > MAX_GIF_DURATION:
                await update.message.reply_text(
                    f"‚ùå –í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ GIF.\n"
                    f"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {MAX_GIF_DURATION} —Å–µ–∫ ({MAX_GIF_DURATION/60:.0f} –º–∏–Ω)\n"
                    f"–¢–µ–∫—É—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration} —Å–µ–∫"
                )
                return
        
        file_info = {
            'file_id': document.file_id,
            'file_name': document.file_name or f"file_{len(user_info['files']) + 1}.{source_ext}",
            'file_size': document.file_size,
            'mime_type': document.mime_type,
            'message_id': update.message.message_id,
            'duration': document.duration if hasattr(document, 'duration') else 0
        }
        
        async with user_data_lock:
            user_info['files'].append(file_info)
        
        remaining = user_info['max_files'] - len(user_info['files'])
        
        if remaining > 0:
            message = (
                f"‚úÖ –§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω!\n\n"
                f"üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(user_info['files'])}/{user_info['max_files']}\n"
                f"üìù –û—Å—Ç–∞–ª–æ—Å—å –º–µ—Å—Ç: {remaining}\n\n"
                f"üìÑ –§–∞–π–ª: {os.path.basename(file_info['file_name'])}\n"
                f"üìè –†–∞–∑–º–µ—Ä: {file_info['file_size'] / 1024:.1f} –ö–ë\n\n"
                f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â—ë —Ñ–∞–π–ª—ã –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏."
            )
        else:
            message = (
                f"‚úÖ –§–∞–π–ª –¥–æ–±–∞–≤–ª–µ–Ω!\n\n"
                f"üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(user_info['files'])}/{user_info['max_files']}\n\n"
                f"üìä –í—Å–µ —Ñ–∞–π–ª—ã –ø–æ–ª—É—á–µ–Ω—ã! –ù–∞—á–∏–Ω–∞—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é..."
            )
        
        keyboard = [
            [InlineKeyboardButton("üöÄ –ù–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é", callback_data='start_conversion')],
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data='back_to_category')]
        ] if remaining > 0 else []
        
        await update.message.reply_text(
            message,
            reply_markup=InlineKeyboardMarkup(keyboard) if keyboard else None
        )
        
        if remaining == 0:
            await convert_command(update, context)

@check_ban
async def handle_photos(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π"""
    user_id = update.effective_user.id
    db.update_activity(user_id)
    
    async with user_data_lock:
        if user_id not in user_data:
            keyboard = [
                [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
                [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
                [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')]
            ]
            await update.message.reply_text(
                "‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é.",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
            return
        
        user_info = user_data[user_id]
    
    if user_info['source'] not in ['jpg', 'png', 'webp', 'GIF']:
        await update.message.reply_text(
            "‚ùå –í—ã –≤—ã–±—Ä–∞–ª–∏ –Ω–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–¥–µ–ª '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è' –≤ –º–µ–Ω—é.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')]
            ])
        )
        return
    
    if len(user_info['files']) >= user_info['max_files']:
        await update.message.reply_text(
            f"‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º {user_info['max_files']} —Ñ–∞–π–ª–æ–≤.\n"
            "–û—Ç–ø—Ä–∞–≤—å—Ç–µ /convert –¥–ª—è –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏."
        )
        return
    
    if update.message.photo:
        photo = update.message.photo[-1]
        
        if photo.file_size and photo.file_size > user_info['max_size']:
            max_mb = user_info['max_size'] // (1024 * 1024)
            await update.message.reply_text(f"‚ùå –§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º—É–º: {max_mb} –ú–ë.")
            return
        
        file_info = {
            'file_id': photo.file_id,
            'file_name': f"photo_{len(user_info['files']) + 1}.jpg",
            'file_size': photo.file_size,
            'mime_type': 'image/jpeg',
            'message_id': update.message.message_id
        }
        
        async with user_data_lock:
            user_info['files'].append(file_info)
        
        remaining = user_info['max_files'] - len(user_info['files'])
        
        if remaining > 0:
            message = (
                f"‚úÖ –§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!\n\n"
                f"üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(user_info['files'])}/{user_info['max_files']}\n"
                f"üì∏ –û—Å—Ç–∞–ª–æ—Å—å –º–µ—Å—Ç: {remaining}\n\n"
                f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â—ë —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏."
            )
        else:
            message = (
                f"‚úÖ –§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!\n\n"
                f"üì¶ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {len(user_info['files'])}/{user_info['max_files']}\n\n"
                f"üìä –í—Å–µ —Ñ–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω—ã! –ù–∞—á–∏–Ω–∞—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é..."
            )
        
        keyboard = [
            [InlineKeyboardButton("üöÄ –ù–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é", callback_data='start_conversion')],
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data='back_to_category')]
        ] if remaining > 0 else []
        
        await update.message.reply_text(
            message,
            reply_markup=InlineKeyboardMarkup(keyboard) if keyboard else None
        )
        
        if remaining == 0:
            await convert_command(update, context)

@check_ban
async def handle_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ"""
    user_id = update.effective_user.id
    db.update_activity(user_id)
    
    async with user_data_lock:
        if user_id not in user_data:
            keyboard = [
                [InlineKeyboardButton("üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", callback_data='category_images')],
                [InlineKeyboardButton("üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã", callback_data='category_documents')],
                [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')]
            ]
            await update.message.reply_text(
                "‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –º–µ–Ω—é.",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
            return
        
        user_info = user_data[user_id]
    
    if user_info['type'] not in ['mp4_to_GIF', 'video_to_mp3', 'video_to_wav', 'video_to_flac']:
        await update.message.reply_text(
            "‚ùå –í—ã –≤—ã–±—Ä–∞–ª–∏ –Ω–µ –≤–∏–¥–µ–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–¥–µ–ª '–í–∏–¥–µ–æ/–ê—É–¥–∏–æ' –≤ –º–µ–Ω—é.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("üé¨ –í–∏–¥–µ–æ/–ê—É–¥–∏–æ", callback_data='category_video')]
            ])
        )
        return
    
    if len(user_info['files']) >= user_info['max_files']:
        await update.message.reply_text(f"‚ùå –ú–∞–∫—Å–∏–º—É–º {user_info['max_files']} —Ñ–∞–π–ª–æ–≤.")
        return
    
    if update.message.video:
        video = update.message.video
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ GIF (–¥–æ 4 –º–∏–Ω—É—Ç)
        if user_info['type'] == 'mp4_to_GIF' and video.duration and video.duration > MAX_GIF_DURATION:
            await update.message.reply_text(
                f"‚ùå –í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ GIF.\n"
                f"–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {MAX_GIF_DURATION} —Å–µ–∫ ({MAX_GIF_DURATION/60:.0f} –º–∏–Ω)\n"
                f"–¢–µ–∫—É—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {video.duration} —Å–µ–∫"
            )
            return
        
        if video.file_size and video.file_size > user_info['max_size']:
            max_mb = user_info['max_size'] // (1024 * 1024)
            await update.message.reply_text(f"‚ùå –í–∏–¥–µ–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º—É–º: {max_mb} –ú–ë.")
            return
        
        file_info = {
            'file_id': video.file_id,
            'file_name': video.file_name or f"video_{len(user_info['files']) + 1}.mp4",
            'file_size': video.file_size,
            'mime_type': video.mime_type,
            'message_id': update.message.message_id,
            'duration': video.duration
        }
        
        async with user_data_lock:
            user_info['files'].append(file_info)
        
        size_mb = video.file_size / (1024 * 1024) if video.file_size else 0
        duration_text = f"{video.duration} —Å–µ–∫" if video.duration else "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        
        message = (
            f"‚úÖ –í–∏–¥–µ–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!\n\n"
            f"üìπ –†–∞–∑–º–µ—Ä: {size_mb:.1f} –ú–ë\n"
            f"‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {duration_text}\n"
            f"üåê –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –æ–Ω–ª–∞–π–Ω-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è\n\n"
            f"–û—Ç–ø—Ä–∞–≤—å—Ç–µ /convert –¥–ª—è –Ω–∞—á–∞–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏."
        )
        
        keyboard = [
            [InlineKeyboardButton("üöÄ –ù–∞—á–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é", callback_data='start_conversion')],
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data='back_to_category')]
        ]
        
        await update.message.reply_text(
            message,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

@check_ban
async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥"""
    user_id = update.effective_user.id
    db.update_activity(user_id)
    
    text = update.message.text.lower().strip()
    
    text_commands = {
        '–≥–æ—Ç–æ–≤–æ': 'convert',
        '–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å': 'convert',
        'start': 'convert',
        'go': 'convert',
        'convert': 'convert',
        '–Ω–∞—á–∞—Ç—å': 'convert',
        '—Å—Ç–∞—Ä—Ç': 'convert',
        '–æ—Ç–º–µ–Ω–∞': 'cancel',
        'cancel': 'cancel',
        '—Å—Ç–æ–ø': 'cancel',
        'stop': 'cancel',
        '–ø–æ–º–æ—â—å': 'help',
        'help': 'help',
        '—Å–ø—Ä–∞–≤–∫–∞': 'help',
        '–º–µ–Ω—é': 'start',
        'menu': 'start',
        '–Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞': 'start',
        '–ø—Ä–æ—Ñ–∏–ª—å': 'profile',
        'profile': 'profile'
    }
    
    if text in text_commands:
        command = text_commands[text]
        if command == 'convert':
            await convert_command(update, context)
        elif command == 'cancel':
            await cancel(update, context)
        elif command == 'help':
            await help_command(update, context)
        elif command == 'start':
            await start(update, context)
        elif command == 'profile':
            await profile_command(update, context)

# ==================== –ó–ê–ü–£–°–ö –ë–û–¢–ê ====================

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    global application
    
    application = Application.builder().token(TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("convert", convert_command))
    application.add_handler(CommandHandler("cancel", cancel))
    application.add_handler(CommandHandler("profile", profile_command))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(MessageHandler(filters.PHOTO, handle_photos))
    application.add_handler(MessageHandler(filters.Document.ALL, handle_documents))
    application.add_handler(MessageHandler(filters.VIDEO, handle_video))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    
    logger.info("üöÄ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    logger.info(f"üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã: {ADMIN_IDS}")    
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()